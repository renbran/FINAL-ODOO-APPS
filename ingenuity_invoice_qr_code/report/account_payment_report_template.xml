<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Payment Report with QR Code Support -->
    <template id="report_payment_receipt_qr" inherit_id="account.report_payment_receipt_document">
        <xpath expr="//div[hasclass('page')]" position="inside">
            <!-- QR Code Section for Payments -->
            <div class="row mt-4" t-if="o.qr_in_report and o.qr_code">
                <div class="col-12 text-center">
                    <h5>Payment Verification QR Code</h5>
                    <div style="border: 2px solid #000; padding: 10px; display: inline-block; background: white;">
                        <img t-att-src="'data:image/png;base64,' + (o.qr_code.decode('utf-8') if o.qr_code else '')" 
                             style="width:150px; height:150px;" 
                             alt="Payment Verification QR Code"
                             t-if="o.qr_code"/>
                    </div>
                    <p class="text-muted mt-2">
                        <small><strong>Scan to verify payment authenticity</strong></small><br/>
                        <small t-if="o.validation_url">Validation URL: <span t-esc="o.validation_url"/></small>
                    </p>
                    <div class="mt-2" t-if="o.validation_token">
                        <small class="text-info">
                            <i class="fa fa-shield"/> Secure validation system enabled<br/>
                            Token expires: <span t-esc="o.validation_token_expiry.strftime('%Y-%m-%d') if o.validation_token_expiry else 'N/A'"/>
                        </small>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Payment Voucher Report Enhancement -->
    <template id="report_payment_voucher_qr">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        
                        <!-- Header -->
                        <div class="row mb-4">
                            <div class="col-6">
                                <h3>
                                    <span t-if="o.payment_type == 'inbound'">Payment Receipt</span>
                                    <span t-if="o.payment_type == 'outbound'">Payment Voucher</span>
                                </h3>
                            </div>
                            <div class="col-6 text-right">
                                <h4 t-field="o.name"/>
                                <p>Date: <span t-field="o.date"/></p>
                            </div>
                        </div>

                        <!-- Payment Details -->
                        <div class="row mb-4">
                            <div class="col-6">
                                <strong>
                                    <span t-if="o.payment_type == 'inbound'">Received From:</span>
                                    <span t-if="o.payment_type == 'outbound'">Paid To:</span>
                                </strong>
                                <div t-field="o.partner_id.name"/>
                                <div t-field="o.partner_id.street" t-if="o.partner_id.street"/>
                                <div t-field="o.partner_id.city" t-if="o.partner_id.city"/>
                                <div t-field="o.partner_id.country_id.name" t-if="o.partner_id.country_id"/>
                            </div>
                            <div class="col-6">
                                <strong>Payment Method:</strong>
                                <div t-field="o.journal_id.name"/>
                                <br/>
                                <strong>Amount:</strong>
                                <div class="h4" t-field="o.amount" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                            </div>
                        </div>

                        <!-- Reference -->
                        <div class="row mb-4" t-if="o.ref">
                            <div class="col-12">
                                <strong>Reference:</strong>
                                <span t-field="o.ref"/>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div class="row mt-4" t-if="o.qr_in_report and o.qr_code">
                            <div class="col-12 text-center">
                                <h5>Payment QR Code</h5>
                                <div style="border: 2px solid #000; padding: 15px; display: inline-block; background: white; margin: 20px 0;">
                                    <img t-att-src="'data:image/png;base64,' + (o.qr_code.decode('utf-8') if o.qr_code else '')" 
                                         style="width:200px; height:200px;" 
                                         alt="Payment QR Code"
                                         t-if="o.qr_code"/>
                                </div>
                                <p class="text-muted">
                                    <small>Scan this QR code for payment verification</small>
                                </p>
                            </div>
                        </div>

                        <div class="oe_structure"/>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Report Action for Payment Voucher with QR -->
    <record id="action_report_payment_voucher_qr" model="ir.actions.report">
        <field name="name">Payment Voucher (QR)</field>
        <field name="model">account.payment</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ingenuity_invoice_qr_code.report_payment_voucher_qr</field>
        <field name="report_file">ingenuity_invoice_qr_code.report_payment_voucher_qr</field>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_type">report</field>
    </record>
</odoo>
