<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Inherit res.partner form view -->
    <record id="view_partner_form_duplicate" model="ir.ui.view">
        <field name="name">res.partner.form.duplicate</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="before">
                <header>
                    <button name="action_find_duplicates" type="object" 
                            string="Find Duplicates" 
                            class="btn-primary"
                            groups="base.group_user"/>
                    <button name="action_merge_with_contact" type="object" 
                            string="Merge Contact" 
                            class="btn-secondary"
                            groups="base.group_user"/>
                </header>
            </xpath>
            
            <xpath expr="//page[@name='sales_purchases']" position="after">
                <page name="duplicates" string="Duplicates" 
                      attrs="{'invisible': [('duplicate_count', '=', 0)]}">
                    <group>
                        <field name="is_duplicate_checked"/>
                        <field name="duplicate_count"/>
                    </group>
                    <field name="duplicate_contact_ids">
                        <tree>
                            <field name="duplicate_partner_id"/>
                            <field name="similarity_score" widget="percentage"/>
                            <field name="matching_fields"/>
                            <field name="state"/>
                            <button name="action_mark_as_duplicate" type="object"
                                    string="Merge" icon="fa-compress"
                                    attrs="{'invisible': [('state', 'in', ['merged', 'ignored'])]}"/>
                            <button name="action_ignore_duplicate" type="object"
                                    string="Ignore" icon="fa-times"
                                    attrs="{'invisible': [('state', 'in', ['merged', 'ignored'])]}"/>
                        </tree>
                    </field>
                </page>
                
                <page name="merge_history" string="Merge History"
                      attrs="{'invisible': [('merge_history_ids', '=', [])]}">
                    <field name="merge_history_ids">
                        <tree>
                            <field name="merge_date"/>
                            <field name="merge_user_id"/>
                            <field name="notes"/>
                        </tree>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Inherit res.partner tree view -->
    <record id="view_partner_tree_duplicate" model="ir.ui.view">
        <field name="name">res.partner.tree.duplicate</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='phone']" position="after">
                <field name="duplicate_count" string="Duplicates"/>
                <field name="is_duplicate_checked" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Search view for partners with duplicates -->
    <record id="view_partner_search_duplicate" model="ir.ui.view">
        <field name="name">res.partner.search.duplicate</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='inactive']" position="after">
                <separator/>
                <filter name="has_duplicates" string="Has Duplicates"
                        domain="[('duplicate_count', '>', 0)]"/>
                <filter name="not_checked" string="Not Checked for Duplicates"
                        domain="[('is_duplicate_checked', '=', False)]"/>
            </xpath>
        </field>
    </record>

</odoo>
