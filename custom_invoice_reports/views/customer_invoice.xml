<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Custom Invoice Layout Template -->
    <template id="custom_invoice_layout" inherit_id="account.report_invoice_document">
        <xpath expr="//div[@id='informations']" position="replace">
            <!-- Custom Header with QR Code and Sender Information -->
            <div class="row mt-4 mb-4">
                <div class="col-3">
                    <!-- QR Code Placeholder - Will need to implement QR code generation -->
                    <div class="border p-2" style="width: 100px; height: 100px;" t-if="o.company_id.logo">
                        <img t-att-src="'/report/barcode/?type=QR&amp;value=' + o.name" style="width:100%;height:100%;"/>
                    </div>
                    <div class="mt-2">
                        <strong>From:</strong><br/>
                        <span t-field="o.company_id.name"/><br/>
                        <span t-field="o.company_id.phone"/><br/>
                        <span t-field="o.company_id.email"/><br/>
                        <span t-if="o.company_id.vat">VAT: <span t-field="o.company_id.vat"/></span>
                    </div>
                </div>
                <div class="col-6 text-center">
                    <!-- Center aligned content if needed -->
                </div>
                <div class="col-3 text-end">
                    <h3 t-if="o.company_id.name">
                        <span t-field="o.company_id.name"/>
                    </h3>
                </div>
            </div>

            <!-- Invoice Title and Number with Bold Red Styling -->
            <div class="row">
                <div class="col-12">
                    <h2 style="color: #8b0000; font-weight: bold;">
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">TAX Invoice </span>
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Draft Invoice </span>
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Invoice </span>
                        <span t-if="o.move_type == 'out_refund'">Credit Note </span>
                        <span t-if="o.move_type == 'in_refund'">Vendor Credit Note </span>
                        <span t-if="o.move_type == 'in_invoice'">Vendor Bill </span>
                        <span t-field="o.name"/>
                    </h2>
                </div>
            </div>

            <!-- Invoice Information Table -->
            <div class="row mt-3">
                <div class="col-3">
                    <strong>Invoice Date:</strong><br/>
                    <span t-field="o.invoice_date" t-options="{'widget': 'date'}"/>
                </div>
                <div class="col-3">
                    <strong>Due Date:</strong><br/>
                    <span t-field="o.invoice_date_due" t-options="{'widget': 'date'}"/>
                </div>
                <div class="col-3">
                    <span t-if="o.source" name="source_field">
                        <strong>Source:</strong><br/>
                        <span t-field="o.source"/>
                    </span>
                    <span t-else="">
                        <strong>Source:</strong><br/>
                        <t t-if="'deal_id' in o and o.deal_id">
                            <span t-field="o.deal_id"/>
                        </t>
                    </span>
                </div>
                <div class="col-3">
                    <span t-if="o.ref" name="reference_field">
                        <strong>Reference:</strong><br/>
                        <span t-field="o.ref"/>
                    </span>
                    <span t-else="">
                        <strong>Reference:</strong><br/>
                        <t t-if="'project_id' in o and o.project_id">
                            <span t-field="o.project_id.name"/>
                        </t>
                        <t t-if="'unit_id' in o and o.unit_id">
                            <span t-field="o.unit_id"/>
                        </t>
                    </span>
                </div>
            </div>

            <!-- Product Table Header with Dark Red Background -->
            <div class="row mt-4">
                <div class="col-12">
                    <table class="table table-sm o_main_table" name="invoice_line_table">
                        <thead style="background-color: #8b0000; color: white;">
                            <tr>
                                <th name="th_buyer" class="text-start">BUYER NAME</th>
                                <th name="th_project" class="text-start">PROJECT</th>
                                <th name="th_unit" class="text-start">UNIT</th>
                                <th name="th_quantity" class="text-end">QTY</th>
                                <th name="th_priceunit" class="text-end">UNIT PRICE</th>
                                <th name="th_taxes" class="text-end">VAT</th>
                                <th name="th_amount" class="text-end">AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody class="invoice_tbody">
                            <tr t-foreach="o.invoice_line_ids" t-as="line">
                                <!-- Customer name instead of description -->
                                <td name="account_invoice_line_name">
                                    <t t-if="'buyer_id' in o and o.buyer_id">
                                        <span t-field="o.buyer_id.name"/>
                                    </t>
                                    <t t-else="">
                                        <span t-field="o.partner_id.name"/>
                                    </t>
                                </td>
                                <!-- Project Name -->
                                <td name="account_invoice_project">
                                    <t t-if="'project_id' in o and o.project_id">
                                        <span t-field="o.project_id.name"/>
                                    </t>
                                    <t t-else="">
                                        <span t-field="line.name"/>
                                    </t>
                                </td>
                                <!-- Unit ID -->
                                <td name="account_invoice_unit">
                                    <t t-if="'unit_id' in o and o.unit_id">
                                        <span t-field="o.unit_id"/>
                                    </t>
                                    <t t-else="">
                                        <span>-</span>
                                    </t>
                                </td>
                                <!-- Quantity -->
                                <td class="text-end">
                                    <span t-field="line.quantity"/>
                                </td>
                                <!-- Unit price -->
                                <td class="text-end">
                                    <span t-field="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                                <!-- Taxes -->
                                <td class="text-end">
                                    <span t-field="line.tax_ids.name"/>
                                </td>
                                <!-- Amount -->
                                <td class="text-end o_price_total">
                                    <span t-field="line.price_total" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </xpath>

        <!-- Customize the totals section -->
        <xpath expr="//div[@id='total']" position="replace">
            <div class="row">
                <div class="col-6">
                    <!-- Payment instructions -->
                    <div class="mt-4">
                        <p><strong>Payment Communication:</strong> <span t-if="'project_id' in o and o.project_id"><span t-field="o.project_id.name"/></span> <span t-if="'unit_id' in o and o.unit_id"><span t-field="o.unit_id"/></span></p>
                        
                        <p><strong>Please make payment on this account:</strong></p>
                        <p><strong>Bank:</strong> <span t-field="o.company_id.bank_ids[0].bank_name" t-if="o.company_id.bank_ids"/>
                        <br/><strong>Account Name:</strong> <span t-field="o.company_id.name"/>
                        <br/><strong>Account No.:</strong> <span t-field="o.company_id.bank_ids[0].acc_number" t-if="o.company_id.bank_ids"/>
                        <br/><strong>IBAN:</strong> <span t-field="o.company_id.bank_ids[0].acc_number" t-if="o.company_id.bank_ids"/>
                        <br/><strong>Branch:</strong> <span t-field="o.company_id.bank_ids[0].branch_name" t-if="o.company_id.bank_ids"/>
                        <br/><strong>Currency:</strong> <span t-field="o.currency_id"/></p>
                    </div>
                </div>
                <div class="col-6">
                    <!-- Amount totals with dark red background for header -->
                    <div class="clearfix">
                        <table class="table table-sm" style="page-break-inside: avoid;">
                            <tr>
                                <td><strong>Untaxed Amount</strong></td>
                                <td class="text-end">
                                    <span t-field="o.amount_untaxed" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>VAT</span>
                                    <span t-field="o.amount_tax_signed" class="ms-1"/>
                                </td>
                                <td class="text-end">
                                    <span t-field="o.amount_tax" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                            </tr>
                            <tr style="background-color: #8b0000; color: white;">
                                <td><strong>Total</strong></td>
                                <td class="text-end">
                                    <span t-field="o.amount_total" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Register the custom invoice layout template -->
    <template id="custom_account_report_invoice" inherit_id="account.report_invoice">
        <xpath expr="//t[@t-call='account.report_invoice_document']" position="attributes">
            <attribute name="t-call">custom_invoice_reports.custom_invoice_layout</attribute>
        </xpath>
    </template>
</odoo>