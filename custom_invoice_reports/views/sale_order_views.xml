<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Add invoice fields to sale.order model to match the invoice format -->
    <record id="sale_order_invoice_field_extensions" model="ir.ui.view">
        <field name="name">sale.order.invoice.fields</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="view_order_form_inherit_deal_tracking"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@string='Deal Information']" position="after">
                <group string="Invoice Information">
                    <group>
                        <field name="source" placeholder="Source reference (e.g. PS76550)"/>
                        <field name="invoice_layout_id" domain="[('invoice_layout', '=', True)]"/>
                    </group>
                </group>
            </xpath>
        </field>
    </record>
    
    <!-- Add source field to sale.order model -->
    <record id="sale_order_source_field" model="ir.model.fields">
        <field name="name">source</field>
        <field name="model">sale.order</field>
        <field name="field_description">Source</field>
        <field name="ttype">char</field>
    </record>
    
    <!-- Add invoice_layout_id field to sale.order model -->
    <record id="sale_order_invoice_layout_field" model="ir.model.fields">
        <field name="name">invoice_layout_id</field>
        <field name="model">sale.order</field>
        <field name="field_description">Invoice Layout</field>
        <field name="ttype">many2one</field>
        <field name="relation">doc.layout</field>
    </record>
    
    <!-- Add corresponding fields to account.move model -->
    <record id="account_move_field_extensions" model="ir.model.fields">
        <field name="name">source</field>
        <field name="model">account.move</field>
        <field name="field_description">Source</field>
        <field name="ttype">char</field>
    </record>
    
    <record id="account_move_buyer_field" model="ir.model.fields">
        <field name="name">buyer_id</field>
        <field name="model">account.move</field>
        <field name="field_description">Buyer</field>
        <field name="ttype">many2one</field>
        <field name="relation">res.partner</field>
    </record>
    
    <record id="account_move_project_field" model="ir.model.fields">
        <field name="name">project_id</field>
        <field name="model">account.move</field>
        <field name="field_description">Project</field>
        <field name="ttype">many2one</field>
        <field name="relation">project.project</field>
    </record>
    
    <record id="account_move_unit_field" model="ir.model.fields">
        <field name="name">unit_id</field>
        <field name="model">account.move</field>
        <field name="field_description">Unit</field>
        <field name="ttype">char</field>
    </record>
    
    <record id="account_move_invoice_layout_field" model="ir.model.fields">
        <field name="name">invoice_layout_id</field>
        <field name="model">account.move</field>
        <field name="field_description">Invoice Layout</field>
        <field name="ttype">many2one</field>
        <field name="relation">doc.layout</field>
    </record>
    
    <!-- Add the fields to the invoice form view -->
    <record id="account_move_form_view_inherit" model="ir.ui.view">
        <field name="name">account.move.form.invoice.custom</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@id='header_left_group']" position="after">
                <group string="Real Estate Details" options="{'invisible': [('move_type', 'not in', ['out_invoice', 'out_refund'])]}">
                    <field name="source"/>
                    <field name="buyer_id"/>
                    <field name="project_id"/>
                    <field name="unit_id"/>
                    <field name="invoice_layout_id" domain="[('invoice_layout', '=', True)]"/>
                </group>
            </xpath>
        </field>
    </record>
    
    <!-- Python code to handle transfer of fields from SO to Invoice -->
    <data noupdate="1">
        <function model="ir.model.fields" name="create">
            <value eval="{'name': '_transfer_so_to_invoice', 
                          'model': 'sale.order', 
                          'ttype': 'boolean', 
                          'store': False,
                          'compute': '''
for rec in self:
    if not rec.invoice_ids:
        continue
    for invoice in rec.invoice_ids:
        invoice.source = rec.source
        invoice.buyer_id = rec.buyer_id
        invoice.project_id = rec.project_id
        invoice.unit_id = rec.unit_id
        invoice.invoice_layout_id = rec.invoice_layout_id
'''}"/>
        </function>
    </data>
</odoo>