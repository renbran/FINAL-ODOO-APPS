<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Enhanced Payment Form View -->
    <record id="view_account_payment_form_enhanced" model="ir.ui.view">
        <field name="name">account.payment.form.enhanced</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form"/>
        <field name="arch" type="xml">
            <!-- Replace status bar to include approval states -->
            <xpath expr="//field[@name='state']" position="replace">
                <field name="state" widget="statusbar" statusbar_visible="draft,submitted,under_review,approved,authorized,posted"/>
            </xpath>

            <!-- Add approval workflow buttons -->
            <xpath expr="//header" position="inside">
                <!-- Submit for Approval -->
                <button name="action_submit_for_approval" string="Submit for Approval" type="object" class="btn-primary" invisible="state != 'draft' or not requires_approval"/>

                <!-- Approve -->
                <button name="action_approve" string="Approve" type="object" class="btn-success" invisible="state not in ['submitted', 'under_review'] or not is_approve_person"/>

                <!-- Authorize -->
                <button name="action_authorize" string="Authorize" type="object" class="btn-success" invisible="state != 'approved' or not is_approve_person"/>

                <!-- Reject -->
                <button name="action_reject" string="Reject" type="object" class="btn-danger" invisible="state not in ['submitted', 'under_review', 'approved'] or not is_approve_person"/>

                <!-- Set to Draft -->
                <button name="action_set_to_draft" string="Set to Draft" type="object" class="btn-secondary" invisible="state not in ['rejected', 'cancelled']"/>
            </xpath>

            <!-- Add voucher information after amount field -->
            <xpath expr="//field[@name='amount']" position="after">
                <field name="voucher_number" readonly="1"/>
                <field name="voucher_type" readonly="1"/>
                <field name="requires_approval" invisible="1"/>
                <field name="is_approve_person" invisible="1"/>
            </xpath>

            <!-- Add approval threshold information -->
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="approval_threshold" invisible="not requires_approval" readonly="1" string="Approval Required Above"/>
            </xpath>

            <!-- Add approval information tab -->
            <xpath expr="//notebook" position="inside">
                <page string="Approval Information" invisible="not requires_approval">
                    <group>
                        <group string="Approval Status">
                            <field name="approved_by" readonly="1"/>
                            <field name="approved_date" readonly="1"/>
                            <field name="authorized_by" readonly="1"/>
                            <field name="authorized_date" readonly="1"/>
                            <field name="authorized_approvers_display" readonly="1"/>
                        </group>
                        <group string="Rejection Information">
                            <field name="rejection_reason" readonly="1"/>
                        </group>
                    </group>
                    <separator string="Approval History"/>
                    <field name="approval_history" readonly="1"/>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Enhanced Payment List View with Bulk Actions -->
    <record id="view_account_payment_tree_enhanced" model="ir.ui.view">
        <field name="name">account.payment.tree.enhanced</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_tree"/>
        <field name="arch" type="xml">
            <!-- Add voucher fields to tree view -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="voucher_number" optional="show"/>
                <field name="voucher_type" optional="hide"/>
            </xpath>

            <!-- Add approval fields -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="requires_approval" optional="hide"/>
                <field name="approved_by" optional="hide"/>
                <field name="approved_date" optional="hide"/>
            </xpath>

            <!-- Add bulk action buttons in control panel -->
            <xpath expr="//tree" position="attributes">
                <attribute name="js_class">payment_approval_list</attribute>
            </xpath>
        </field>
    </record>

    <!-- Search view enhancements -->
    <record id="view_account_payment_search_enhanced" model="ir.ui.view">
        <field name="name">account.payment.search.enhanced</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_search"/>
        <field name="arch" type="xml">
            <!-- Add approval-related filters -->
            <xpath expr="//filter[@name='state_posted']" position="after">
                <separator/>
                <filter name="state_submitted" string="Submitted" domain="[('state', '=', 'submitted')]"/>
                <filter name="state_under_review" string="Under Review" domain="[('state', '=', 'under_review')]"/>
                <filter name="state_approved" string="Approved" domain="[('state', '=', 'approved')]"/>
                <filter name="state_authorized" string="Authorized" domain="[('state', '=', 'authorized')]"/>
                <filter name="state_rejected" string="Rejected" domain="[('state', '=', 'rejected')]"/>
                <separator/>
                <filter name="requires_approval" string="Requires Approval" domain="[('requires_approval', '=', True)]"/>
                <filter name="can_approve" string="I Can Approve" domain="[('is_approve_person', '=', True)]"/>
            </xpath>

            <!-- Add groupby options -->
            <xpath expr="//group" position="inside">
                <filter string="Voucher Type" name="group_voucher_type" domain="[]" context="{'group_by': 'voucher_type'}"/>
                <filter string="Approved By" name="group_approved_by" domain="[]" context="{'group_by': 'approved_by'}"/>
            </xpath>

            <!-- Add search fields -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="voucher_number"/>
                <field name="approved_by"/>
                <field name="authorized_by"/>
            </xpath>
        </field>
    </record>

    <!-- Action for bulk operations -->
    <record id="action_payment_bulk_approve_post" model="ir.actions.server">
        <field name="name">Bulk Approve & Post</field>
        <field name="model_id" ref="account.model_account_payment"/>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">action = records.bulk_approve_and_post()</field>
        <field name="groups_id" eval="[(4, ref('group_payment_voucher_approver'))]"/>
    </record>

    <record id="action_payment_bulk_reject" model="ir.actions.server">
        <field name="name">Bulk Reject</field>
        <field name="model_id" ref="account.model_account_payment"/>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">action = records.bulk_reject()</field>
        <field name="groups_id" eval="[(4, ref('group_payment_voucher_approver'))]"/>
    </record>

    <record id="action_payment_bulk_draft" model="ir.actions.server">
        <field name="name">Bulk Set to Draft</field>
        <field name="model_id" ref="account.model_account_payment"/>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">action = records.bulk_set_to_draft()</field>
    </record>

    <record id="action_payment_bulk_submit" model="ir.actions.server">
        <field name="name">Bulk Submit for Approval</field>
        <field name="model_id" ref="account.model_account_payment"/>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">action = records.bulk_submit_for_approval()</field>
    </record>
</odoo>