<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <!-- Statement report template -->
    <template id="res_partner_statement_report_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <h3 style="text-align: center; color: #800020; font-weight: bold; margin-bottom: 30px;">
                        Payment Statement Report
                    </h3>
                </div>
                
                <!-- Customer Information Section -->
                <div style="margin-bottom: 30px;">
                    <table style="width: 100%; border: none;">
                        <tr>
                            <td style="font-weight: bold; font-size: 16px; color: #800020;">
                                <t t-esc="customer"/>
                            </td>
                        </tr>
                        <t t-if="street">
                            <tr>
                                <td style="padding-top: 5px;">
                                    <t t-esc="street"/>
                                </td>
                            </tr>
                        </t>
                        <t t-if="street2">
                            <tr>
                                <td style="padding-top: 5px;">
                                    <t t-esc="street2"/>
                                </td>
                            </tr>
                        </t>
                        <t t-if="city">
                            <tr>
                                <td style="padding-top: 5px;">
                                    <t t-esc="city"/>
                                </td>
                            </tr>
                        </t>
                        <t t-if="state">
                            <tr>
                                <td style="padding-top: 5px;">
                                    <t t-esc="state"/>
                                </td>
                            </tr>
                        </t>
                    </table>
                </div>

                <!-- Aging Analysis Section -->
                <t t-if="aging_buckets">
                    <div class="clearfix" name="aging_summary" style="page-break-inside: avoid; margin-bottom: 40px;">
                        <!-- Header -->
                        <h4 style="text-align: center; 
                                   background: linear-gradient(135deg, #800020 0%, #4B0082 50%, #800020 100%); 
                                   color: white; 
                                   padding: 15px; 
                                   border-radius: 8px; 
                                   margin-bottom: 20px; 
                                   font-weight: bold; 
                                   text-transform: uppercase; 
                                   letter-spacing: 2px;
                                   box-shadow: 0 4px 8px rgba(128, 0, 32, 0.3);">
                            ðŸ“Š AGING ANALYSIS SUMMARY
                        </h4>
                        
                        <!-- Clean Aging Buckets Table -->
                        <div style="border-radius: 12px;
                                   padding: 3px;
                                   margin-bottom: 15px;
                                   box-shadow: 0 6px 12px rgba(0,0,0,0.2);">
                            
                            <table style="width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; border: 2px solid #800020;">
                                <!-- Headers Row -->
                                <thead>
                                    <tr>
                                        <th style="background: #800020; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 12px;
                                                   border-right: 1px solid #ddd;">
                                            CURRENT<br/>
                                            <small style="font-size: 10px;">(0-30 days)</small>
                                        </th>
                                        <th style="background: #800020; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 12px;
                                                   border-right: 1px solid #ddd;">
                                            PAST DUE<br/>
                                            <small style="font-size: 10px;">(31-60 days)</small>
                                        </th>
                                        <th style="background: #800020; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 12px;
                                                   border-right: 1px solid #ddd;">
                                            OVERDUE<br/>
                                            <small style="font-size: 10px;">(61-90 days)</small>
                                        </th>
                                        <th style="background: #800020; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 12px;
                                                   border-right: 1px solid #ddd;">
                                            CRITICAL<br/>
                                            <small style="font-size: 10px;">(91-120 days)</small>
                                        </th>
                                        <th style="background: #800020; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 12px;
                                                   border-right: 1px solid #ddd;">
                                            VERY OVERDUE<br/>
                                            <small style="font-size: 10px;">(120+ days)</small>
                                        </th>
                                        <th style="background: #000000; 
                                                   color: white; 
                                                   padding: 12px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold;
                                                   font-size: 13px;">
                                            TOTAL OUTSTANDING
                                        </th>
                                    </tr>
                                </thead>
                                
                                <!-- Values Row -->
                                <tbody style="background: white;">
                                    <tr style="background: white;">
                                        <td style="background: white; 
                                                   color: #333; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 14px;
                                                   border-right: 1px solid #ddd;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="current_val" t-value="float(aging_buckets.get('current', 0))"/>
                                            <t t-set="formatted_current" t-value="'{:,.2f}'.format(current_val)"/>
                                            <t t-set="clean_current" t-value="formatted_current.rstrip('0').rstrip('.') if '.' in formatted_current else formatted_current"/>
                                            <t t-esc="currency"/><t t-esc="clean_current"/>
                                        </td>
                                        <td style="background: white; 
                                                   color: #333; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 14px;
                                                   border-right: 1px solid #ddd;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="days30_val" t-value="float(aging_buckets.get('days_30', 0))"/>
                                            <t t-set="formatted_days30" t-value="'{:,.2f}'.format(days30_val)"/>
                                            <t t-set="clean_days30" t-value="formatted_days30.rstrip('0').rstrip('.') if '.' in formatted_days30 else formatted_days30"/>
                                            <t t-esc="currency"/><t t-esc="clean_days30"/>
                                        </td>
                                        <td style="background: white; 
                                                   color: #333; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 14px;
                                                   border-right: 1px solid #ddd;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="days60_val" t-value="float(aging_buckets.get('days_60', 0))"/>
                                            <t t-set="formatted_days60" t-value="'{:,.2f}'.format(days60_val)"/>
                                            <t t-set="clean_days60" t-value="formatted_days60.rstrip('0').rstrip('.') if '.' in formatted_days60 else formatted_days60"/>
                                            <t t-esc="currency"/><t t-esc="clean_days60"/>
                                        </td>
                                        <td style="background: white; 
                                                   color: #333; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 14px;
                                                   border-right: 1px solid #ddd;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="days90_val" t-value="float(aging_buckets.get('days_90', 0))"/>
                                            <t t-set="formatted_days90" t-value="'{:,.2f}'.format(days90_val)"/>
                                            <t t-set="clean_days90" t-value="formatted_days90.rstrip('0').rstrip('.') if '.' in formatted_days90 else formatted_days90"/>
                                            <t t-esc="currency"/><t t-esc="clean_days90"/>
                                        </td>
                                        <td style="background: white; 
                                                   color: #333; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 14px;
                                                   border-right: 1px solid #ddd;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="days120_val" t-value="float(aging_buckets.get('days_120', 0))"/>
                                            <t t-set="formatted_days120" t-value="'{:,.2f}'.format(days120_val)"/>
                                            <t t-set="clean_days120" t-value="formatted_days120.rstrip('0').rstrip('.') if '.' in formatted_days120 else formatted_days120"/>
                                            <t t-esc="currency"/><t t-esc="clean_days120"/>
                                        </td>
                                        <td style="background: #000000; 
                                                   color: white; 
                                                   padding: 18px 8px; 
                                                   text-align: center; 
                                                   font-weight: bold; 
                                                   font-size: 16px;
                                                   border-bottom: 1px solid #ddd;">
                                            <t t-set="total_val" t-value="float(aging_buckets.get('total', 0))"/>
                                            <t t-set="formatted_total" t-value="'{:,.2f}'.format(total_val)"/>
                                            <t t-set="clean_total" t-value="formatted_total.rstrip('0').rstrip('.') if '.' in formatted_total else formatted_total"/>
                                            <t t-esc="currency"/><t t-esc="clean_total"/>
                                        </td>
                                    </tr>
                                </tbody>
                                
                                <!-- Percentage Distribution Row -->
                                <t t-if="aging_buckets.get('total', 0) > 0">
                                    <tbody style="background: white;">
                                        <tr style="background: white;">
                                            <t t-set="total_aging" t-value="aging_buckets.get('total', 0)"/>
                                            <td style="background: white; 
                                                       color: #666; 
                                                       padding: 10px 8px; 
                                                       text-align: center; 
                                                       font-size: 11px; 
                                                       font-weight: bold;
                                                       border-right: 1px solid #ddd;">
                                                <t t-esc="'{:.1f}%'.format((aging_buckets.get('current', 0) / total_aging * 100) if total_aging > 0 else 0)"/>
                                            </td>
                                            <td style="background: white; 
                                                       color: #666; 
                                                       padding: 10px 8px; 
                                                       text-align: center; 
                                                       font-size: 11px; 
                                                       font-weight: bold;
                                                       border-right: 1px solid #ddd;">
                                                <t t-esc="'{:.1f}%'.format((aging_buckets.get('days_30', 0) / total_aging * 100) if total_aging > 0 else 0)"/>
                                            </td>
                                            <td style="background: white; 
                                                       color: #666; 
                                                       padding: 10px 8px; 
                                                       text-align: center; 
                                                       font-size: 11px; 
                                                       font-weight: bold;
                                                       border-right: 1px solid #ddd;">
                                                <t t-esc="'{:.1f}%'.format((aging_buckets.get('days_60', 0) / total_aging * 100) if total_aging > 0 else 0)"/>
                                            </td>
                                            <td style="background: white; 
                                                       color: #666; 
                                                       padding: 10px 8px; 
                                                       text-align: center; 
                                                       font-size: 11px; 
                                                       font-weight: bold;
                                                       border-right: 1px solid #ddd;">
                                                <t t-esc="'{:.1f}%'.format((aging_buckets.get('days_90', 0) / total_aging * 100) if total_aging > 0 else 0)"/>
                                            </td>
                                            <td style="background: white; 
                                                       color: #666; 
                                                       padding: 10px 8px; 
                                                   text-align: center; 
                                                       font-size: 11px; 
                                                       font-weight: bold;
                                                       border-right: 1px solid #ddd;">
                                                <t t-esc="'{:.1f}%'.format((aging_buckets.get('days_120', 0) / total_aging * 100) if total_aging > 0 else 0)"/>
                                            </td>
                                            <td style="background: #000000; 
                                                       color: white; 
                                                       padding: 10px 8px; 
                                                       text-align: center; 
                                                       font-weight: bold; 
                                                       font-size: 12px;">
                                                100.0%
                                            </td>
                                        </tr>
                                    </tbody>
                                </t>
                            </table>
                        </div>
                    </div>
                </t>

                <!-- Invoice Details Section -->
                <div style="margin-top: 30px;">
                    <!-- Header -->
                    <h4 style="text-align: center; 
                               background: #800020; 
                               color: white; 
                               padding: 15px; 
                               border-radius: 8px; 
                               margin-bottom: 20px; 
                               font-weight: bold; 
                               text-transform: uppercase; 
                               letter-spacing: 2px;
                               box-shadow: 0 4px 8px rgba(128, 0, 32, 0.3);">
                        ðŸ“‹ INVOICE DETAILS
                    </h4>
                    
                    <table class="table table-bordered" style="width: 100%; border-collapse: collapse; border: 2px solid #800020;">
                        <thead>
                            <tr style="background: #800020; color: white;">
                                <th style="padding: 12px; text-align: center; font-weight: bold; border-right: 1px solid #ddd;">
                                    Date
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: bold; border-right: 1px solid #ddd;">
                                    Invoice/Bill Number
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: bold; border-right: 1px solid #ddd;">
                                    Reference
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: bold; border-right: 1px solid #ddd;">
                                    Due Date
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: bold; border-right: 1px solid #ddd;">
                                    Invoices/Debit
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: bold;">
                                    Balance
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="my_data" t-as="line">
                                <tr style="background: white;">
                                    <!-- Date Column -->
                                    <td style="padding: 10px; text-align: center; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                        <t t-if="line['invoice_date']">
                                            <t t-set="date_obj" t-value="line['invoice_date']"/>
                                            <t t-if="hasattr(date_obj, 'strftime')">
                                                <t t-esc="date_obj.strftime('%d-%b-%Y')"/>
                                            </t>
                                            <t t-else="">
                                                <t t-set="date_str" t-value="str(date_obj)[:10]"/>
                                                <t t-if="'-' in date_str and len(date_str) == 10">
                                                    <t t-set="date_parts" t-value="date_str.split('-')"/>
                                                    <t t-set="month_names" t-value="['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']"/>
                                                    <t t-set="month_idx" t-value="int(date_parts[1]) - 1"/>
                                                    <t t-esc="date_parts[2]"/>-<t t-esc="month_names[month_idx]"/>-<t t-esc="date_parts[0]"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-esc="date_obj"/>
                                                </t>
                                            </t>
                                        </t>
                                    </td>
                                    
                                    <!-- Invoice Number Column -->
                                    <td style="padding: 10px; text-align: center; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                        <t t-set="is_overdue" t-value="line.get('invoice_date_due') and str(line.get('invoice_date_due')) &lt; str(datetime.date.today()) if 'datetime' in globals() else False"/>
                                        <span t-att-style="'color: #dc3545; font-weight: 500;' if is_overdue else 'color: #000000;'">
                                            <t t-esc="line['name']"/>
                                        </span>
                                    </td>
                                    
                                    <!-- Reference Column -->
                                    <td style="padding: 10px; text-align: center; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                        <t t-set="is_overdue" t-value="line.get('invoice_date_due') and str(line.get('invoice_date_due')) &lt; str(datetime.date.today()) if 'datetime' in globals() else False"/>
                                        <span t-att-style="'color: #dc3545; font-weight: 500;' if is_overdue else 'color: #000000;'">
                                            <t t-esc="line['ref'] or ''"/>
                                        </span>
                                    </td>
                                    
                                    <!-- Due Date Column -->
                                    <td style="padding: 10px; text-align: center; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                        <t t-if="line['invoice_date_due']">
                                            <t t-set="due_date_obj" t-value="line['invoice_date_due']"/>
                                            <t t-set="is_overdue" t-value="str(due_date_obj) &lt; str(datetime.date.today()) if 'datetime' in globals() else False"/>
                                            <span t-att-style="'color: #dc3545; font-weight: 500;' if is_overdue else 'color: #000000;'">
                                                <t t-if="hasattr(due_date_obj, 'strftime')">
                                                    <t t-esc="due_date_obj.strftime('%d-%b-%Y')"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-set="due_date_str" t-value="str(due_date_obj)[:10]"/>
                                                    <t t-if="'-' in due_date_str and len(due_date_str) == 10">
                                                        <t t-set="due_date_parts" t-value="due_date_str.split('-')"/>
                                                        <t t-set="month_names" t-value="['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']"/>
                                                        <t t-set="due_month_idx" t-value="int(due_date_parts[1]) - 1"/>
                                                        <t t-esc="due_date_parts[2]"/>-<t t-esc="month_names[due_month_idx]"/>-<t t-esc="due_date_parts[0]"/>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-esc="due_date_obj"/>
                                                    </t>
                                                </t>
                                            </span>
                                        </t>
                                    </td>
                                    
                                    <!-- Invoice Amount Column -->
                                    <td style="padding: 10px; text-align: center; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; font-weight: bold;">
                                        <t t-set="is_overdue" t-value="line.get('invoice_date_due') and str(line.get('invoice_date_due')) &lt; str(datetime.date.today()) if 'datetime' in globals() else False"/>
                                        <span t-att-style="'color: #dc3545; font-weight: 500;' if is_overdue else 'color: #000000;'">
                                            <t t-set="amount_val" t-value="float(line['sub_total'] or 0)"/>
                                            <t t-set="formatted_amount" t-value="'{:,.2f}'.format(amount_val)"/>
                                            <t t-set="clean_amount" t-value="formatted_amount.rstrip('0').rstrip('.') if '.' in formatted_amount else formatted_amount"/>
                                            <t t-esc="currency"/><t t-esc="clean_amount"/>
                                        </span>
                                    </td>
                                    
                                    <!-- Balance Column -->
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold;">
                                        <t t-set="is_overdue" t-value="line.get('invoice_date_due') and str(line.get('invoice_date_due')) &lt; str(datetime.date.today()) if 'datetime' in globals() else False"/>
                                        <span t-att-style="'color: #dc3545; font-weight: 500;' if is_overdue else 'color: #800020;'">
                                            <t t-set="balance_val" t-value="float(line['balance'] or 0)"/>
                                            <t t-set="formatted_balance" t-value="'{:,.2f}'.format(balance_val)"/>
                                            <t t-set="clean_balance" t-value="formatted_balance.rstrip('0').rstrip('.') if '.' in formatted_balance else formatted_balance"/>
                                            <t t-esc="currency"/><t t-esc="clean_balance"/>
                                        </span>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                <!-- Totals Summary Section -->
                <t t-if="total">
                    <div class="clearfix" name="so_total_summary" style="margin-top: 30px;">
                        <!-- Header -->
                        <h4 style="text-align: center; 
                                   background: #800020; 
                                   color: white; 
                                   padding: 15px; 
                                   border-radius: 8px; 
                                   margin-bottom: 20px; 
                                   font-weight: bold; 
                                   text-transform: uppercase; 
                                   letter-spacing: 2px;
                                   box-shadow: 0 4px 8px rgba(128, 0, 32, 0.3);">
                            ðŸ’° TOTALS SUMMARY
                        </h4>
                        
                        <div class="row">
                            <div class="col-6 ms-auto">
                                <table class="table table-sm" style="border: 2px solid #800020; border-radius: 8px; overflow: hidden; background: white;">
                                    <thead>
                                        <tr style="background: #800020; color: white;">
                                            <th style="padding: 12px; font-weight: bold; color: white; border-right: 1px solid #ddd;">
                                                Description
                                            </th>
                                            <th style="padding: 12px; font-weight: bold; color: white; text-align: right;">
                                                Amount
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;">
                                        <tr style="background: white;">
                                            <td style="padding: 12px; font-weight: bold; color: #333; background: white; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                                Total Amount:
                                            </td>
                                            <td style="padding: 12px; font-weight: bold; text-align: right; background: white; border-bottom: 1px solid #ddd;">
                                                <t t-set="total_val" t-value="float(total or 0)"/>
                                                <t t-set="formatted_total" t-value="'{:,.2f}'.format(total_val)"/>
                                                <t t-set="clean_total" t-value="formatted_total.rstrip('0').rstrip('.') if '.' in formatted_total else formatted_total"/>
                                                <t t-esc="currency"/><t t-esc="clean_total"/>
                                            </td>
                                        </tr>
                                        <tr style="background: white;">
                                            <td style="padding: 12px; font-weight: bold; color: #333; background: white; border-right: 1px solid #ddd;">
                                                Total Balance:
                                            </td>
                                            <td style="padding: 12px; font-weight: bold; text-align: right; font-size: 16px; color: #800020; background: white;">
                                                <t t-set="balance_val" t-value="float(balance or 0)"/>
                                                <t t-set="formatted_balance" t-value="'{:,.2f}'.format(balance_val)"/>
                                                <t t-set="clean_balance" t-value="formatted_balance.rstrip('0').rstrip('.') if '.' in formatted_balance else formatted_balance"/>
                                                <t t-esc="currency"/><t t-esc="clean_balance"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Footer with Timestamp -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #800020;">
                    <table style="width: 100%; border: none;">
                        <tr>
                            <td style="width: 50%; text-align: left; vertical-align: bottom;">
                                <div style="font-size: 12px; color: #666;">
                                    <strong style="color: #800020;">Statement Details:</strong><br/>
                                    This statement shows all outstanding invoices<br/>
                                    and their aging analysis as of the report date.
                                </div>
                            </td>
                            <td style="width: 50%; text-align: right; vertical-align: bottom;">
                                <div style="font-size: 12px; color: #666;">
                                    <strong style="color: #800020;">Report Generated:</strong><br/>
                                    <span style="font-weight: bold; color: #333;">
                                        <t t-esc="report_timestamp"/>
                                    </span><br/>
                                    <span style="font-size: 10px; color: #999;">
                                        System Time (UTC<t t-esc="report_timezone"/>)
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </t>
        </t>
    </template>
</odoo>