<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View Extension -->
    <record id="view_order_form_commission" model="ir.ui.view">
        <field name="name">sale.order.form.commission</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Group all deal info fields together after client_order_ref -->
            <xpath expr="//field[@name='client_order_ref']" position="after">
                <group string="Deal Information">
                    <!-- <field name="deal_id"/> -->
                    <field name="booking_date"/>
                    <field name="buyer_id"/>
                    <field name="project_id"/>
                    <field name="unit_id"/>
                    <field name="sale_value"/>
                </group>
            </xpath>

            <!-- Commission Tab -->
            <xpath expr="//page[@name='other_information']" position="after">
                <page string="Commission" name="commission">
                    <group>
                        <group string="Commission Status">
                            <field name="commission_status"/>
                            <field name="commission_payment_date" invisible="commission_status not in ['confirmed', 'paid']"/>
                            <field name="commission_reference" invisible="commission_status not in ['confirmed', 'paid']"/>
                        </group>
                        <group string="Commission Notes">
                            <field name="commission_notes" widget="html"/>
                        </group>
                        <group string="Commission Summary">
                            <field name="broker_commission"/>
                            <field name="total_internal_commission" readonly="1"/>
                            <field name="total_external_commission" readonly="1"/>
                            <field name="grand_total_commission" readonly="1"/>
                            <field name="commission_allocation_status" readonly="1"/>
                            <field name="company_net_commission" readonly="1"/>
                            <field name="commission_percentage"/>
                        </group>
                    </group>
                    <group string="Commission Breakdown">
                        <group string="External Commission" colspan="2">
                            <field name="external_partner_id"/>
                            <field name="external_commission_type"/>
                            <field name="external_percentage" attrs="{'invisible': [('external_commission_type', '!=', 'unit_price')]}"/>
                            <field name="external_fixed_amount" attrs="{'invisible': [('external_commission_type', '!=', 'fixed')]}"/>
                            <field name="external_commission_amount" readonly="1"/>
                            <field name="broker_agency_partner_id"/>
                            <field name="broker_agency_commission_type"/>
                            <field name="broker_agency_rate"/>
                            <field name="broker_agency_total" readonly="1"/>
                            <field name="referral_partner_id"/>
                            <field name="referral_commission_type"/>
                            <field name="referral_rate"/>
                            <field name="referral_total" readonly="1"/>
                            <field name="cashback_partner_id"/>
                            <field name="cashback_commission_type"/>
                            <field name="cashback_rate"/>
                            <field name="cashback_total" readonly="1"/>
                            <field name="other_external_partner_id"/>
                            <field name="other_external_commission_type"/>
                            <field name="other_external_rate"/>
                            <field name="other_external_total" readonly="1"/>
                        </group>
                        <group string="Internal Commission" colspan="2">
                            <field name="internal_commission_type"/>
                            <field name="internal_commission_base" readonly="1"/>
                            <label for="internal_commission_base">
                                <span class="o_form_label_help">This is the company share (after external commission) used as the base for internal commission calculation.</span>
                            </label>
                            <field name="agent1_id"/>
                            <field name="agent1_rate" attrs="{'invisible': [('internal_commission_type', '!=', 'unit_price')]}"/>
                            <field name="agent1_fixed" attrs="{'invisible': [('internal_commission_type', '!=', 'fixed')]}"/>
                            <field name="agent1_commission" readonly="1"/>
                            <field name="agent2_id"/>
                            <field name="agent2_rate" attrs="{'invisible': [('internal_commission_type', '!=', 'unit_price')]}"/>
                            <field name="agent2_fixed" attrs="{'invisible': [('internal_commission_type', '!=', 'fixed')]}"/>
                            <field name="agent2_commission" readonly="1"/>
                            <field name="manager_id"/>
                            <field name="manager_rate" attrs="{'invisible': [('internal_commission_type', '!=', 'unit_price')]}"/>
                            <field name="manager_fixed" attrs="{'invisible': [('internal_commission_type', '!=', 'fixed')]}"/>
                            <field name="manager_commission" readonly="1"/>
                            <field name="director_id"/>
                            <field name="director_rate" attrs="{'invisible': [('internal_commission_type', '!=', 'unit_price')]}"/>
                            <field name="director_fixed" attrs="{'invisible': [('internal_commission_type', '!=', 'fixed')]}"/>
                            <field name="director_commission" readonly="1"/>
                        </group>
                    </group>
                    <group string="Commission Calculations">
                        <field name="commission_calculation_ids"/>
                        <button name="action_view_commission_calculations" type="object" string="View Calculations" class="oe_stat_button" icon="fa-calculator"/>
                    </group>
                </page>
            </xpath>

            <!-- Commission Buttons -->
            <xpath expr="//header//button[@name='action_confirm']" position="before">
                <button name="action_calculate_commission" 
                        string="Calculate Commission" 
                        type="object" 
                        class="btn-primary"
                        attrs="{'invisible': [('can_calculate_commission', '=', False)]}"/>
                <button name="action_confirm_commission" 
                        string="Confirm Commission" 
                        type="object" 
                        class="btn-primary"
                        attrs="{'invisible': [('can_confirm_commission', '=', False)]}"/>
                <button name="action_pay_commission" 
                        string="Mark as Paid" 
                        type="object" 
                        class="btn-primary"
                        attrs="{'invisible': [('can_pay_commission', '=', False)]}"/>
                <button name="action_reset_commission" 
                        string="Reset Commission" 
                        type="object" 
                        class="btn-secondary"
                        attrs="{'invisible': [('can_reset_commission', '=', False)]}"/>
            </xpath>

            <!-- Smart Buttons -->
            <xpath expr="//div[@class='oe_button_box']" position="inside">
                <button name="action_view_related_purchase_orders"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-shopping-cart">
                    <field name="commission_purchase_order_count" widget="statinfo" string="Commission POs"/>
                </button>
            </xpath>

            <!-- Commission Alert -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-info" role="alert" 
                     style="height: 40px; margin-bottom:0px;" 
                     invisible="not has_due">
                    This Customer has due amounts
                </div>
            </xpath>
        </field>
    </record>

    <!-- Tree View Extension -->
    <record id="view_order_tree_commission" model="ir.ui.view">
        <field name="name">sale.order.tree.commission</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
            <field name="name" position="after">
                <!-- <field name="deal_id"/> -->
                <field name="commission_status"/>
                <field name="broker_commission" sum="Total Broker Commission"/>
                <field name="commission_percentage"/>
            </field>
        </field>
    </record>

    <!-- Search View Extension -->
    <record id="view_sales_order_filter_commission" model="ir.ui.view">
        <field name="name">sale.order.list.select.commission</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <!-- <field name="deal_id"/> -->
                <field name="commission_reference"/>
                <field name="buyer_id"/>
            </xpath>
            <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                <separator/>
                <filter string="Draft Commission" name="draft_commission" domain="[('commission_status','=','draft')]"/>
                <filter string="Confirmed Commission" name="confirmed_commission" domain="[('commission_status','=','confirmed')]"/>
                <filter string="Paid Commission" name="paid_commission" domain="[('commission_status','=','paid')]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Commission Status" name="commission_status" context="{'group_by':'commission_status'}"/>
                <filter string="Payment Date" name="commission_payment_date" context="{'group_by':'commission_payment_date'}"/>
            </xpath>
        </field>
    </record>
</odoo>