<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View Inheritance: Add Commission Tab to Sale Order -->
    <record id="view_order_form_inherit_commission" model="ir.ui.view"> 
        <field name="name">sale.order.form.inherit.commission</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                <page string="Commissions" name="commissions">
                    <group>
                        <group name="commission_general" string="Commission Details">
                            <field name="x_sale_value"/>
                            <field name="untaxed_total" readonly="1"/>
                            <field name="commission_status"/>
                            <field name="commission_processed"/>
                        </group>
                        <group name="commission_summary" string="Commission Summary">
                            <field name="total_commission_amount"/>
                            <field name="company_share"/>
                            <field name="net_company_share"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="External Party" name="external_party_commission">
                            <group name="external_party_details">
                                <group>
                                    <field name="external_party_id"/>
                                    <field name="external_party_calculation_type"/>
                                    <field name="external_party_base_amount" options="{'invisible': [('external_party_calculation_type', 'in', ['fixed', 'by_sales_value', 'by_untaxed'])], 'required': [('external_party_calculation_type', '=', 'percentage')]}"/>
                                    <field name="external_party_percentage" options="{'invisible': [('external_party_calculation_type', '=', 'fixed')], 'required': [('external_party_calculation_type', 'in', ['percentage', 'by_sales_value', 'by_untaxed'])]}"/>
                                    <field name="external_party_fixed_amount" options="{'invisible': [('external_party_calculation_type', '!=', 'fixed')], 'required': [('external_party_calculation_type', '=', 'fixed')]}"/>
                                </group>
                                <group>
                                    <field name="external_party_commission" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Consultant" name="consultant_commission">
                            <group name="consultant_details">
                                <group>
                                    <field name="consultant_id"/>
                                    <field name="consultant_calculation_type"/>
                                    <field name="consultant_base_amount" options="{'invisible': [('consultant_calculation_type', 'in', ['fixed', 'by_sales_value', 'by_untaxed'])], 'required': [('consultant_calculation_type', '=', 'percentage')]}"/>
                                    <field name="consultant_percentage" options="{'invisible': [('consultant_calculation_type', '=', 'fixed')], 'required': [('consultant_calculation_type', 'in', ['percentage', 'by_sales_value', 'by_untaxed'])]}"/>
                                    <field name="consultant_fixed_amount" options="{'invisible': [('consultant_calculation_type', '!=', 'fixed')], 'required': [('consultant_calculation_type', '=', 'fixed')]}"/>
                                </group>
                                <group>
                                    <field name="consultant_commission" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Second Agent" name="second_agent_commission">
                            <group name="second_agent_details">
                                <group>
                                    <field name="second_agent_id"/>
                                    <field name="second_agent_calculation_type"/>
                                    <field name="second_agent_base_amount" options="{'invisible': [('second_agent_calculation_type', 'in', ['fixed', 'by_sales_value', 'by_untaxed'])], 'required': [('second_agent_calculation_type', '=', 'percentage')]}"/>
                                    <field name="second_agent_percentage" options="{'invisible': [('second_agent_calculation_type', '=', 'fixed')], 'required': [('second_agent_calculation_type', 'in', ['percentage', 'by_sales_value', 'by_untaxed'])]}"/>
                                    <field name="second_agent_fixed_amount" options="{'invisible': [('second_agent_calculation_type', '!=', 'fixed')], 'required': [('second_agent_calculation_type', '=', 'fixed')]}"/>
                                </group>
                                <group>
                                    <field name="second_agent_commission" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Manager" name="manager_commission">
                            <group name="manager_details">
                                <group>
                                    <field name="manager_id"/>
                                    <field name="manager_calculation_type"/>
                                    <field name="manager_base_amount" options="{'invisible': [('manager_calculation_type', 'in', ['fixed', 'by_sales_value', 'by_untaxed'])], 'required': [('manager_calculation_type', '=', 'percentage')]}"/>
                                    <field name="manager_percentage" options="{'invisible': [('manager_calculation_type', '=', 'fixed')], 'required': [('manager_calculation_type', 'in', ['percentage', 'by_sales_value', 'by_untaxed'])]}"/>
                                    <field name="manager_fixed_amount" options="{'invisible': [('manager_calculation_type', '!=', 'fixed')], 'required': [('manager_calculation_type', '=', 'fixed')]}"/>
                                </group>
                                <group>
                                    <field name="manager_commission" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Director" name="director_commission">
                            <group name="director_details">
                                <group>
                                    <field name="director_id"/>
                                    <field name="director_calculation_type"/>
                                    <field name="director_base_amount" options="{'invisible': [('director_calculation_type', 'in', ['fixed', 'by_sales_value', 'by_untaxed'])], 'required': [('director_calculation_type', '=', 'percentage')]}"/>
                                    <field name="director_percentage" options="{'invisible': [('director_calculation_type', '=', 'fixed')], 'required': [('director_calculation_type', 'in', ['percentage', 'by_sales_value', 'by_untaxed'])]}"/>
                                    <field name="director_fixed_amount" options="{'invisible': [('director_calculation_type', '!=', 'fixed')], 'required': [('director_calculation_type', '=', 'fixed')]}"/>
                                </group>
                                <group>
                                    <field name="director_commission" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Purchase Orders" name="commission_pos">
                            <field name="purchase_order_ids">
                                <tree>
                                    <field name="name"/>
                                    <field name="partner_id"/>
                                    <field name="date_order"/>
                                    <field name="amount_total"/>
                                    <field name="commission_posted"/>
                                    <field name="origin"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>

                    <footer>
                        <button name="action_process_commissions"
                                string="Process Commissions"
                                type="object"
                                class="btn-primary"
                                options="{'invisible': [('commission_status', '=', 'completed')]}"/>
                    </footer>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Tree View Inheritance: Add Commission Status -->
    <record id="view_purchase_order_form_inherit" model="ir.ui.view">
        <field name="name">purchase.order.form.inherit</field>
        <field name="model">purchase.order</field>
        <field name="inherit_id" ref="purchase.purchase_order_form"/>
        <field name="arch" type="xml">
            <sheet position="inside">
                <group>
                    <field name="origin_so_id" readonly="1" string="Source Sale Order"/>
                    <field name="commission_details" readonly="1" string="Commission Details"/>
                </group>
            </sheet>
        </field>
    </record>           

    <!-- Server Action: Process Multiple Commissions -->
    <record id="action_process_commissions_multi" model="ir.actions.server">
        <field name="name">Process Commissions</field>
        <field name="model_id" ref="sale.model_sale_order"/>
        <field name="state">code</field>
        <field name="code">
         action = "records.action_process_commissions"
        </field>
        <field name="binding_model_id" ref="sale.model_sale_order"/>
        <field name="binding_type">action</field>
    </record>

    <!-- Scheduled Action: Check Related Invoices for Commission Processing -->
    <record id="ir_cron_check_commission_invoices" model="ir.cron">
        <field name="name">Check Commission Invoices</field>
        <field name="model_id" ref="purchase.model_purchase_order"/>
        <field name="state">code</field>
        <field name="code">model._check_related_invoices()</field>
        <field name="interval_number">1</field>
        <field name="interval_type">hours</field>
        <field name="numbercall">-1</field>
        <field name="doall" eval="False"/>
        <field name="active" eval="True"/>
    </record>

    <!-- Menu Item to Access Sales with Commission -->
    <record id="action_sale_order_commission" model="ir.actions.act_window">
        <field name="name">Sales Commissions</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('commission_status', '!=', 'completed')]</field>
        <field name="context">{'default_commission_status': 'pending'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Process sales commissions
            </p>
        </field>
    </record>

    <menuitem id="menu_sale_commissions"
              name="Sales Commissions"
              parent="sale.sale_menu_root"
              action="action_sale_order_commission"
              sequence="20"/>
</odoo>