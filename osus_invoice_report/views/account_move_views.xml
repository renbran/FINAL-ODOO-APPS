<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit account move form view to add custom print buttons -->
    <record id="view_move_form_inherit_osus_v2" model="ir.ui.view">
        <field name="name">account.move.form.inherit.osus.reports.v2</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Add Deal Tracking Tab -->
            <xpath expr="//sheet/notebook" position="inside">
                <page string="Deal Tracking" invisible="move_type not in ('out_invoice', 'out_refund')">
                    <!-- Deal Summary Banner -->
                    <div class="alert alert-info" invisible="not is_property_deal" role="alert">
                        <strong>Property Deal Summary:</strong>
                        <span invisible="not buyer_id">Buyer: <field name="buyer_id" class="oe_inline"/></span>
                        <span invisible="not project_id">| Project: <field name="project_id" class="oe_inline"/></span>
                        <span invisible="not unit_id">| Unit: <field name="unit_id" class="oe_inline"/></span>
                        <span invisible="not deal_id">| Deal #<field name="deal_id" class="oe_inline"/></span>
                    </div>
                    
                    <group string="Deal Information">
                        <group>
                            <field name="booking_date"/>
                            <field name="deal_id"/>
                            <field name="sale_value" widget="monetary"/>
                        </group>
                        <group>
                            <field name="developer_commission" widget="percentage"/>
                            <field name="commission_amount" widget="monetary" readonly="1"/>
                            <field name="buyer_id" options="{'quick_create': True, 'create_edit': True}"/>
                        </group>
                        <group>
                            <field name="project_id" options="{'quick_create': True, 'create_edit': True}"/>
                            <field name="unit_id" options="{'quick_create': True, 'create_edit': True}"/>
                            <field name="is_property_deal" invisible="1"/>
                        </group>
                    </group>
                    <group string="Report Settings">
                        <group>
                            <field name="qr_in_report"/>
                            <button name="regenerate_qr_code" string="Regenerate QR Code" type="object" 
                                    class="btn-primary" invisible="not qr_in_report"/>
                        </group>
                        <group>
                            <field name="qr_image" widget="image" readonly="1" invisible="not qr_in_report"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Inherit account move tree view to show deal information -->
    <record id="view_move_tree_inherit_osus" model="ir.ui.view">
        <field name="name">account.move.tree.inherit.osus</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <!-- Add deal tracking fields after partner -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="buyer_id" optional="show"/>
                <field name="deal_id" optional="show"/>
                <field name="booking_date" optional="show"/>
                <!-- Add a visual indicator for deals -->
                <field name="is_property_deal" widget="boolean_toggle" optional="show" string="Property Deal"/>
            </xpath>
            
            <!-- Add financial fields after amount total -->
            <xpath expr="//field[@name='amount_total_signed']" position="after">
                <field name="sale_value" widget="monetary" optional="show"/>
                <!-- Add commission amount for quick reference -->
                <field name="commission_amount" widget="monetary" optional="hide" string="Commission"/>
            </xpath>
            
            <!-- Add project info (hidden by default) -->
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="project_id" optional="hide"/>
                <field name="unit_id" optional="hide"/>
                <field name="developer_commission" widget="percentage" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Search view for account moves with deal information -->
    <record id="view_account_move_filter_inherit_osus" model="ir.ui.view">
        <field name="name">account.move.select.inherit.osus</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_move_filter"/>
        <field name="arch" type="xml">
            <!-- Add search fields -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="buyer_id"/>
                <field name="project_id"/>
                <field name="unit_id"/>
                <field name="deal_id"/>
                <field name="booking_date"/>
                <field name="sale_value"/>
            </xpath>
            
            <!-- Add filters -->
            <xpath expr="//field[@name='sale_value']" position="after">
                <separator/>
                <filter string="With Deal ID" name="has_deal_id" domain="[('deal_id', '!=', False)]"/>
                <filter string="With Buyer" name="has_buyer" domain="[('buyer_id', '!=', False)]"/>
                <filter string="With Project" name="has_project" domain="[('project_id', '!=', False)]"/>
                <filter string="Property Deals" name="property_deals" 
                        domain="['|', '|', ('buyer_id', '!=', False), ('project_id', '!=', False), ('deal_id', '!=', False)]"/>
                <filter string="High Value Deals" name="high_value_deals" 
                        domain="[('sale_value', '>', 1000000)]"/>
                <filter string="With Commission" name="has_commission" 
                        domain="[('developer_commission', '>', 0)]"/>
                <separator/>
                <filter string="This Month's Bookings" name="booking_this_month" 
                        domain="[('booking_date', '>=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')), 
                                ('booking_date', '&lt;', (context_today() + relativedelta(months=1, day=1)).strftime('%Y-%m-%d'))]"/>
            </xpath>
            
            <!-- Add group by options -->
            <xpath expr="//group[@expand='0']" position="inside">
                <filter string="Buyer" name="group_buyer" domain="[]" context="{'group_by': 'buyer_id'}"/>
                <filter string="Project" name="group_project" domain="[]" context="{'group_by': 'project_id'}"/>
                <filter string="Unit" name="group_unit" domain="[]" context="{'group_by': 'unit_id'}"/>
                <filter string="Booking Date" name="group_booking_date" domain="[]" context="{'group_by': 'booking_date'}"/>
            </xpath>
        </field>
    </record>

    <!-- Custom Invoice Report Action -->
    <record id="action_report_custom_invoice" model="ir.actions.report">
        <field name="name">OSUS Tax Invoice</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">osus_invoice_report.report_custom_invoice_document</field>
        <field name="report_file">osus_invoice_report.report_custom_invoice_document</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
        <field name="print_report_name">'OSUS-Invoice-%s' % (object.name or 'draft')</field>
        <field name="groups_id" eval="[(4, ref('account.group_account_invoice'))]"/>
    </record>

    <!-- Custom Bill Report Action -->
    <record id="action_report_custom_bill" model="ir.actions.report">
        <field name="name">OSUS Bill</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">osus_invoice_report.report_custom_bill</field>
        <field name="report_file">osus_invoice_report.report_custom_bill</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
        <field name="print_report_name">'OSUS-Bill-%s' % (object.name or 'draft')</field>
        <field name="groups_id" eval="[(4, ref('account.group_account_invoice'))]"/>
    </record>

    <!-- Custom Receipt Report Action -->
    <record id="action_report_custom_receipt" model="ir.actions.report">
        <field name="name">OSUS Receipt</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">osus_invoice_report.report_custom_receipt</field>
        <field name="report_file">osus_invoice_report.report_custom_receipt</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
        <field name="print_report_name">'OSUS-Receipt-%s' % (object.name or 'draft')</field>
        <field name="groups_id" eval="[(4, ref('account.group_account_invoice'))]"/>
    </record>

    <!-- Invoice List Action with Deal Tracking -->
    <record id="action_move_out_invoice_type_osus" model="ir.actions.act_window">
        <field name="name">Invoices with Deal Tracking</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="view_id" ref="view_move_tree_inherit_osus"/>
        <field name="search_view_id" ref="view_account_move_filter_inherit_osus"/>
        <field name="domain">[('move_type', 'in', ('out_invoice', 'out_refund'))]</field>
        <field name="context">{'default_move_type': 'out_invoice'}</field>
        <field name="help">Track property deals and commissions with enhanced invoice views. Use filters to find specific deals quickly.</field>
    </record>

    <!-- Menu item for Invoice List with Deal Tracking -->
    <menuitem 
        id="menu_action_move_out_invoice_type_osus"
        name="Deal Tracking Invoices"
        parent="account.menu_finance_receivables"
        action="action_move_out_invoice_type_osus"
        sequence="15"/>

    <!-- Custom Kanban View for Deal Tracking -->
    <record id="view_move_kanban_deals" model="ir.ui.view">
        <field name="name">account.move.kanban.deals</field>
        <field name="model">account.move</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="buyer_id"/>
                <field name="amount_total"/>
                <field name="sale_value"/>
                <field name="state"/>
                <field name="move_type"/>
                <field name="currency_id"/>
                <field name="booking_date"/>
                <field name="deal_id"/>
                <field name="project_id"/>
                <field name="unit_id"/>
                <field name="is_property_deal"/>
                <field name="commission_amount"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <strong t-esc="record.name.value"/>
                                        <span t-if="record.is_property_deal.raw_value" class="badge badge-info ml-2">Property Deal</span>
                                    </div>
                                    <div class="text-muted">
                                        <t t-esc="record.partner_id.value"/>
                                        <t t-if="record.buyer_id.value"> • Buyer: <t t-esc="record.buyer_id.value"/></t>
                                    </div>
                                </div>
                            </div>
                            <div class="o_kanban_card_content">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Amount: </strong><field name="amount_total" widget="monetary"/>
                                    </div>
                                    <div class="col-6" t-if="record.sale_value.value">
                                        <strong>Sale Value: </strong><field name="sale_value" widget="monetary"/>
                                    </div>
                                </div>
                                <div class="row" t-if="record.deal_id.value or record.booking_date.value">
                                    <div class="col-6" t-if="record.deal_id.value">
                                        <strong>Deal #: </strong><t t-esc="record.deal_id.value"/>
                                    </div>
                                    <div class="col-6" t-if="record.booking_date.value">
                                        <strong>Booked: </strong><t t-esc="record.booking_date.value"/>
                                    </div>
                                </div>
                                <div class="row" t-if="record.project_id.value or record.unit_id.value">
                                    <div class="col-12">
                                        <t t-if="record.project_id.value"><strong>Project: </strong><t t-esc="record.project_id.value"/></t>
                                        <t t-if="record.unit_id.value"> • <strong>Unit: </strong><t t-esc="record.unit_id.value"/></t>
                                    </div>
                                </div>
                                <div class="row" t-if="record.commission_amount.value">
                                    <div class="col-12">
                                        <strong>Commission: </strong><field name="commission_amount" widget="monetary"/>
                                    </div>
                                </div>
                            </div>
                            <div class="o_kanban_card_manage_pane dropdown-menu" role="menu">
                                <a role="menuitem" type="edit" class="dropdown-item">Edit</a>
                                <a role="menuitem" type="delete" class="dropdown-item">Delete</a>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Property Deals Dashboard Action -->
    <record id="action_property_deals_dashboard" model="ir.actions.act_window">
        <field name="name">Property Deals Dashboard</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">kanban,tree,form,graph,pivot</field>
        <field name="view_id" ref="view_move_kanban_deals"/>
        <field name="search_view_id" ref="view_account_move_filter_inherit_osus"/>
        <field name="domain">[('move_type', 'in', ('out_invoice', 'out_refund')), ('is_property_deal', '=', True)]</field>
        <field name="context">{
            'default_move_type': 'out_invoice',
            'search_default_property_deals': 1,
            'search_default_group_buyer': 1
        }</field>
        <field name="help">Comprehensive dashboard for property deal management and analytics</field>
    </record>

    <!-- Menu item for Property Deals Dashboard -->
    <menuitem 
        id="menu_property_deals_dashboard"
        name="Property Deals Dashboard"
        parent="account.menu_finance_receivables"
        action="action_property_deals_dashboard"
        sequence="14"/>
</odoo>