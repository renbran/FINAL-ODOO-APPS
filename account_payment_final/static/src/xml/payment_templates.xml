<?xml version="1.0" encoding="utf-8"?>
<templates xml:space="preserve">
    
    <!-- Modernized Payment Approval Widget Template -->
    <t t-name="account_payment_final.PaymentApprovalWidgetModern" owl="1">
        <div class="o_payment_approval_widget_modern" 
             t-att-class="props.readonly ? 'o_readonly' : ''"
             role="region"
             aria-label="Payment Approval Workflow">
             
            <div class="approval-workflow-container">
                <div class="workflow-header d-flex align-items-center justify-content-between mb-3">
                    <h6 class="text-primary mb-0 d-flex align-items-center">
                        <i class="fa fa-check-circle me-2" aria-hidden="true"></i>
                        <span>Approval Workflow</span>
                    </h6>
                    <div t-if="currentStage" class="current-stage-badge">
                        <span t-attf-class="badge bg-{{ currentStage.color || 'secondary' }}">
                            <i t-attf-class="fa {{ currentStage.icon }} me-1" aria-hidden="true"></i>
                            <t t-esc="currentStage.name"/>
                        </span>
                    </div>
                </div>
                
                <!-- Loading State -->
                <t t-if="state.isLoading">
                    <div class="text-center py-4" role="status" aria-live="polite">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Loading workflow data...</span>
                    </div>
                </t>
                
                <!-- Error State -->
                <t t-elif="state.hasError">
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="fa fa-exclamation-triangle me-2" aria-hidden="true"></i>
                        <div>
                            <strong>Error:</strong>
                            <span t-esc="state.errorMessage"/>
                        </div>
                    </div>
                </t>
                
                <!-- Workflow Stages -->
                <t t-else="">
                    <div class="workflow-stages" role="list">
                        <t t-foreach="formattedStages" t-as="stage" t-key="stage.id">
                            <div t-attf-class="{{ getStageClasses(stage) }}" role="listitem">
                                <div t-attf-class="{{ getStageIconClasses(stage) }}">
                                    <i t-attf-class="fa {{ stage.icon }}" aria-hidden="true"></i>
                                </div>
                                <div class="stage-content flex-grow-1">
                                    <div class="stage-header d-flex align-items-center">
                                        <h6 class="stage-name mb-1" t-esc="stage.name"/>
                                        <span t-if="stage.status === 'completed'" 
                                              class="ms-2 text-success" 
                                              aria-label="Completed">
                                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                                        </span>
                                        <span t-elif="stage.status === 'current'" 
                                              class="ms-2 text-warning" 
                                              aria-label="In Progress">
                                            <i class="fa fa-clock" aria-hidden="true"></i>
                                        </span>
                                    </div>
                                    <div class="stage-description small text-muted mb-1" t-esc="stage.description"/>
                                    <div t-if="stage.user_id" class="stage-user small d-flex align-items-center">
                                        <i class="fa fa-user me-1" aria-hidden="true"></i>
                                        <span t-esc="stage.user_id[1]"/>
                                        <span t-if="stage.date" class="ms-2 text-muted">
                                            on <t t-esc="stage.date"/>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div t-if="state.showActions" class="workflow-actions mt-4">
                        <div class="d-flex gap-2 flex-wrap">
                            <!-- Submit for Review -->
                            <button t-if="canPerformAction('submit')" 
                                    class="btn btn-primary btn-sm" 
                                    t-on-click="onSubmitForReview"
                                    type="button">
                                <i class="fa fa-paper-plane me-1" aria-hidden="true"></i>
                                Submit for Review
                            </button>
                            
                            <!-- Approve -->
                            <button t-if="canPerformAction('approve')" 
                                    class="btn btn-success btn-sm" 
                                    t-on-click="onApprove"
                                    type="button">
                                <i class="fa fa-check me-1" aria-hidden="true"></i>
                                Approve
                            </button>
                            
                            <!-- Authorize -->
                            <button t-if="canPerformAction('authorize')" 
                                    class="btn btn-warning btn-sm" 
                                    t-on-click="onAuthorize"
                                    type="button">
                                <i class="fa fa-key me-1" aria-hidden="true"></i>
                                Authorize
                            </button>
                            
                            <!-- Reject -->
                            <button t-if="canPerformAction('reject')" 
                                    class="btn btn-outline-danger btn-sm" 
                                    t-on-click="onReject"
                                    type="button">
                                <i class="fa fa-times me-1" aria-hidden="true"></i>
                                Reject
                            </button>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>

    <!-- Rejection Reason Dialog Template -->
    <t t-name="account_payment_final.RejectReasonDialog" owl="1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" t-esc="props.title"/>
                    <button type="button" class="btn-close" t-on-click="onCancel" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejection-reason" class="form-label">
                            <strong>Reason for Rejection</strong>
                            <span class="text-danger">*</span>
                        </label>
                        <textarea id="rejection-reason"
                                  class="form-control" 
                                  rows="4" 
                                  placeholder="Please provide a detailed reason for rejecting this payment..."
                                  t-model="state.reason"
                                  t-on-input="onReasonChange"
                                  required="true"></textarea>
                        <div class="form-text">
                            Minimum 10 characters required. Current: <span t-esc="state.reason.length"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">
                        Cancel
                    </button>
                    <button type="button" 
                            class="btn btn-danger" 
                            t-on-click="onConfirm"
                            t-att-disabled="!state.isValid">
                        <i class="fa fa-times me-1"></i>
                        Reject Payment
                    </button>
                </div>
            </div>
        </div>
    </t>
                                t-on-click="onApprove">
                            <i class="fa fa-check me-1"></i>
                            Approve
                        </button>
                    </div>
                </t>
            </div>
        </div>
    </t>
    
    <!-- QR Code Field Widget Template -->
    <t t-name="account_payment_final.QRCodeField" owl="1">
        <div class="o_qr_code_field">
            <t t-if="state.qrCodeData">
                <div class="qr-code-container text-center">
                    <img t-attf-src="data:image/png;base64,{{ state.qrCodeData }}" 
                         alt="Payment QR Code" 
                         class="img-fluid" 
                         style="max-width: 200px; border: 1px solid #ddd; border-radius: 8px;"/>
                    <div class="mt-2">
                        <small class="text-muted">QR Code for Payment Verification</small>
                    </div>
                </div>
            </t>
            <t t-else="">
                <div class="text-center py-3 text-muted">
                    <i class="fa fa-qrcode fa-2x mb-2"></i>
                    <div>QR Code will be generated after saving</div>
                </div>
            </t>
        </div>
    </t>
    
    <!-- Payment List View Enhanced Template -->
    <t t-name="account_payment_final.PaymentListView" owl="1">
        <div class="o_payment_list_enhanced">
            <div class="list-controls mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <div class="filter-buttons">
                            <button class="btn btn-outline-primary btn-sm me-2" 
                                    t-att-class="state.filter === 'all' ? 'active' : ''"
                                    t-on-click="() => this.setFilter('all')">
                                All Payments
                            </button>
                            <button class="btn btn-outline-warning btn-sm me-2"
                                    t-att-class="state.filter === 'pending' ? 'active' : ''"
                                    t-on-click="() => this.setFilter('pending')">
                                Pending Approval
                            </button>
                            <button class="btn btn-outline-success btn-sm"
                                    t-att-class="state.filter === 'approved' ? 'active' : ''"
                                    t-on-click="() => this.setFilter('approved')">
                                Approved
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="search-box">
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   placeholder="Search payments..."
                                   t-model="state.searchTerm"
                                   t-on-input="onSearch"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
    
    <!-- Payment Status Badge Template -->
    <t t-name="account_payment_final.PaymentStatusBadge" owl="1">
        <span t-attf-class="badge payment-status-badge status-{{ props.status }}"
              t-att-title="props.tooltip or ''">
            <i t-if="props.icon" t-attf-class="fa {{ props.icon }} me-1"></i>
            <t t-esc="props.text or props.status"></t>
        </span>
    </t>

</templates>