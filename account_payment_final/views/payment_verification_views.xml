<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Payment Verification Log Views -->
        
        <!-- Tree View -->
        <record id="view_payment_verification_log_tree" model="ir.ui.view">
            <field name="name">payment.verification.log.tree</field>
            <field name="model">payment.verification.log</field>
            <field name="arch" type="xml">
                <tree string="Payment Verification Logs" 
                      default_order="verification_date desc"
                      decoration-success="is_successful == True"
                      decoration-danger="is_successful == False"
                      decoration-info="is_api_call == True">
                    
                    <field name="verification_date"/>
                    <field name="payment_id" optional="show"/>
                    <field name="token" optional="hide"/>
                    <field name="ip_address" optional="show"/>
                    <field name="is_successful"/>
                    <field name="is_api_call" optional="show"/>
                    <field name="action_type" optional="show"/>
                    <field name="country_id" optional="hide"/>
                    <field name="city" optional="hide"/>
                    <field name="error_message" optional="hide"/>
                    
                </tree>
            </field>
        </record>

        <!-- Form View -->
        <record id="view_payment_verification_log_form" model="ir.ui.view">
            <field name="name">payment.verification.log.form</field>
            <field name="model">payment.verification.log</field>
            <field name="arch" type="xml">
                <form string="Payment Verification Log" create="false" edit="false">
                    <header>
                        <button name="action_view_payment_voucher" 
                                string="View Voucher" 
                                type="object" 
                                class="btn-primary"
                                invisible="not payment_id"/>
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_payment_voucher" 
                                    type="object" 
                                    class="oe_stat_button" 
                                    icon="fa-file-text"
                                    invisible="not payment_id">
                                <div class="o_stat_info">
                                    <field name="payment_id" readonly="1"/>
                                    <span class="o_stat_text">Payment Voucher</span>
                                </div>
                            </button>
                        </div>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="display_name"/>
                            </h1>
                            <h3>
                                <field name="action_type" widget="selection"/>
                                <span invisible="not is_api_call" class="badge badge-info ms-2">API</span>
                                <span invisible="is_successful" class="badge badge-danger ms-2">Failed</span>
                                <span invisible="not is_successful" class="badge badge-success ms-2">Success</span>
                            </h3>
                        </div>
                        
                        <group>
                            <group string="Verification Details">
                                <field name="verification_date"/>
                                <field name="token"/>
                                <field name="is_successful"/>
                                <field name="is_api_call"/>
                            </group>
                            
                            <group string="Request Information">
                                <field name="ip_address"/>
                                <field name="country_id"/>
                                <field name="city"/>
                                <field name="user_agent" widget="text"/>
                            </group>
                        </group>
                        
                        <group string="Error Information" invisible="is_successful">
                            <field name="error_message" nolabel="1" widget="text"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Search View -->
        <record id="view_payment_verification_log_search" model="ir.ui.view">
            <field name="name">payment.verification.log.search</field>
            <field name="model">payment.verification.log</field>
            <field name="arch" type="xml">
                <search string="Payment Verification Logs">
                    <field name="payment_id"/>
                    <field name="token"/>
                    <field name="ip_address"/>
                    
                    <filter string="Successful" name="successful" 
                            domain="[('is_successful', '=', True)]"/>
                    <filter string="Failed" name="failed" 
                            domain="[('is_successful', '=', False)]"/>
                    
                    <separator/>
                    <filter string="API Calls" name="api_calls" 
                            domain="[('is_api_call', '=', True)]"/>
                    <filter string="Web Interface" name="web_interface" 
                            domain="[('is_api_call', '=', False)]"/>
                    
                    <separator/>
                    <filter string="Today" name="today" 
                            domain="[('verification_date', '>=', datetime.datetime.combine(context_today(), datetime.time.min))]"/>
                    <filter string="This Week" name="this_week" 
                            domain="[('verification_date', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                    <filter string="This Month" name="this_month" 
                            domain="[('verification_date', '>=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                    
                    <group expand="0" string="Group By">
                        <filter string="Date" name="group_date" 
                                domain="[]" context="{'group_by': 'verification_date:day'}"/>
                        <filter string="Payment Voucher" name="group_payment" 
                                domain="[]" context="{'group_by': 'payment_id'}"/>
                        <filter string="Success Status" name="group_success" 
                                domain="[]" context="{'group_by': 'is_successful'}"/>
                        <filter string="Action Type" name="group_action" 
                                domain="[]" context="{'group_by': 'action_type'}"/>
                        <filter string="Country" name="group_country" 
                                domain="[]" context="{'group_by': 'country_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Actions -->
        <record id="action_payment_verification_log" model="ir.actions.act_window">
            <field name="name">Payment Verification Logs</field>
            <field name="res_model">payment.verification.log</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_payment_verification_log_search"/>
            <field name="context">{'search_default_this_week': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No verification logs found!
                </p>
                <p>
                    Verification logs are created automatically when someone
                    uses the QR code to verify a payment voucher.
                </p>
            </field>
        </record>

        <!-- Website Verification Templates -->
        
        <!-- Successful Verification Template -->
        <template id="payment_verification" name="Payment Voucher Verification">
            <t t-call="website.layout">
                <div id="wrap" class="oe_structure">
                    <div class="container mt-5">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                
                                <!-- Header -->
                                <div class="card border-success mb-4">
                                    <div class="card-header bg-success text-white text-center">
                                        <h2 class="mb-0">
                                            <i class="fa fa-check-circle"/> Payment Voucher Verified
                                        </h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <h4 class="text-success">✓ Verification Successful</h4>
                                                <p class="lead">This payment voucher is authentic and valid.</p>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <img t-if="company.logo" 
                                                     t-att-src="image_data_uri(company.logo)"
                                                     alt="Company Logo" 
                                                     class="img-fluid"
                                                     style="max-height: 80px;"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Voucher Details -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Voucher Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-borderless">
                                                    <tr>
                                                        <td><strong>Voucher Number:</strong></td>
                                                        <td><span class="badge badge-primary" t-esc="payment.voucher_number"/></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Type:</strong></td>
                                                        <td>
                                                            <span t-if="payment.payment_type == 'inbound'" 
                                                                  class="badge badge-success">Receipt</span>
                                                            <span t-else="" class="badge badge-info">Payment</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Amount:</strong></td>
                                                        <td class="h5 text-primary">
                                                            <t t-esc="payment.currency_id.symbol"/>
                                                            <t t-esc="'{:,.2f}'.format(payment.amount)"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Date:</strong></td>
                                                        <td t-esc="payment.date"/>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <table class="table table-borderless">
                                                    <tr>
                                                        <td><strong>Partner:</strong></td>
                                                        <td t-esc="partner.name"/>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Status:</strong></td>
                                                        <td>
                                                            <span t-att-class="'badge badge-' + ('success' if payment.approval_state == 'posted' else 'warning')"
                                                                  t-esc="payment.approval_state.replace('_', ' ').title()"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Company:</strong></td>
                                                        <td t-esc="company.name"/>
                                                    </tr>
                                                    <tr t-if="company.vat">
                                                        <td><strong>Tax ID:</strong></td>
                                                        <td t-esc="company.vat"/>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Related Documents -->
                                <div t-if="related_documents and related_documents['count'] > 0" class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Related Documents</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            <strong t-esc="related_documents['label']"/>: 
                                            <span t-esc="related_documents['references']"/>
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Workflow History -->
                                <div t-if="workflow_history" class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Approval Workflow</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline">
                                            <t t-foreach="workflow_history" t-as="step">
                                                <div class="timeline-item completed">
                                                    <div class="timeline-marker">
                                                        <i class="fa fa-check text-success"/>
                                                    </div>
                                                    <div class="timeline-content">
                                                        <h6 t-esc="step['title']"/>
                                                        <p class="text-muted mb-1">
                                                            By <strong t-esc="step['user']"/> on 
                                                            <span t-esc="step['date']"/>
                                                        </p>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>Need a copy?</h5>
                                        <p class="text-muted">Download a PDF copy of this verified voucher</p>
                                        <a t-att-href="'/payment/verify/download/' + verification_token" 
                                           class="btn btn-primary">
                                            <i class="fa fa-download"/> Download PDF
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Verification Info -->
                                <div class="text-center mt-4">
                                    <small class="text-muted">
                                        Verified on <span t-esc="verification_date"/> | 
                                        Token: <code t-esc="verification_token[:16]"/>...
                                    </small>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Verification Error Template -->
        <template id="verification_error" name="Verification Error">
            <t t-call="website.layout">
                <div id="wrap" class="oe_structure">
                    <div class="container mt-5">
                        <div class="row justify-content-center">
                            <div class="col-lg-6">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white text-center">
                                        <h2 class="mb-0">
                                            <i class="fa fa-times-circle"/> <span t-esc="error_title"/>
                                        </h2>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="mb-4">
                                            <i class="fa fa-exclamation-triangle fa-4x text-warning"/>
                                        </div>
                                        <h4 class="text-danger">Verification Failed</h4>
                                        <p class="lead" t-esc="error_message"/>
                                        
                                        <div class="mt-4">
                                            <small class="text-muted">
                                                If you believe this is an error, please contact support.<br/>
                                                Reference: <code t-esc="token"/>
                                            </small>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <a href="/" class="btn btn-outline-primary">
                                                <i class="fa fa-home"/> Return to Homepage
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Verification Not Found Template -->
        <template id="verification_not_found" name="Voucher Not Found">
            <t t-call="website.layout">
                <div id="wrap" class="oe_structure">
                    <div class="container mt-5">
                        <div class="row justify-content-center">
                            <div class="col-lg-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark text-center">
                                        <h2 class="mb-0">
                                            <i class="fa fa-search"/> <span t-esc="error_title"/>
                                        </h2>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="mb-4">
                                            <i class="fa fa-file-text-o fa-4x text-muted"/>
                                        </div>
                                        <h4 class="text-warning">Voucher Not Found</h4>
                                        <p class="lead" t-esc="error_message"/>
                                        
                                        <div class="alert alert-info mt-4">
                                            <h6>Possible reasons:</h6>
                                            <ul class="list-unstyled text-left">
                                                <li>• The QR code may be damaged or incomplete</li>
                                                <li>• The voucher may have been cancelled</li>
                                                <li>• The verification link may be expired</li>
                                                <li>• The voucher may not exist in our system</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <small class="text-muted">
                                                Token: <code t-esc="token"/>
                                            </small>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <a href="/" class="btn btn-outline-primary">
                                                <i class="fa fa-home"/> Return to Homepage
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Add verification logs to payment form -->
        <record id="view_account_payment_form_verification" model="ir.ui.view">
            <field name="name">account.payment.form.verification</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="view_account_payment_form_enhanced"/>
            <field name="arch" type="xml">
                
                <!-- Add verification button to header -->
                <xpath expr="//header" position="inside">
                    <button name="action_view_verification_logs" 
                            string="Verification Logs" 
                            type="object" 
                            class="btn-outline-info"
                            invisible="verification_count == 0">
                        <span class="badge badge-pill badge-info" t-field="verification_count"/>
                    </button>
                    
                    <button name="action_regenerate_qr_token" 
                            string="Regenerate QR Token" 
                            type="object" 
                            class="btn-outline-warning"
                            groups="account_payment_final.group_payment_voucher_manager"
                            invisible="approval_state == 'draft'"
                            confirm="This will invalidate the current QR code. Continue?"/>
                </xpath>

                <!-- Add verification info to QR verification page -->
                <xpath expr="//page[@name='qr_verification']" position="inside">
                    <group string="Verification Statistics" invisible="verification_count == 0">
                        <group>
                            <field name="verification_count" readonly="1"/>
                            <field name="last_verification_date" readonly="1"/>
                        </group>
                        <group>
                            <field name="is_publicly_verifiable" readonly="1"/>
                            <button name="action_view_verification_logs" 
                                    string="View All Logs" 
                                    type="object" 
                                    class="btn-link"
                                    invisible="verification_count == 0"/>
                        </group>
                    </group>
                </xpath>

            </field>
        </record>

        <!-- Verification Dashboard Action -->
        <record id="action_payment_verification_dashboard" model="ir.actions.act_window">
            <field name="name">Verification Dashboard</field>
            <field name="res_model">payment.verification.log</field>
            <field name="view_mode">graph,pivot,tree</field>
            <field name="context">{
                'search_default_successful': 1,
                'search_default_this_month': 1
            }</field>
        </record>

        <!-- Graph View for Verification Dashboard -->
        <record id="view_payment_verification_log_graph" model="ir.ui.view">
            <field name="name">payment.verification.log.graph</field>
            <field name="model">payment.verification.log</field>
            <field name="arch" type="xml">
                <graph string="Verification Statistics" type="line">
                    <field name="verification_date" type="row" interval="day"/>
                    <field name="is_successful" type="col"/>
                    <field name="id" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- Pivot View for Verification Analysis -->
        <record id="view_payment_verification_log_pivot" model="ir.ui.view">
            <field name="name">payment.verification.log.pivot</field>
            <field name="model">payment.verification.log</field>
            <field name="arch" type="xml">
                <pivot string="Verification Analysis">
                    <field name="verification_date" type="row" interval="week"/>
                    <field name="is_successful" type="col"/>
                    <field name="is_api_call" type="col"/>
                    <field name="id" type="measure"/>
                </pivot>
            </field>
        </record>

    </data>
</odoo>