<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Enhanced Sale Order Form View with Workflow and Commission Fields -->
        <record id="view_order_form_enhanced_workflow" model="ir.ui.view">
            <field name="name">sale.order.form.enhanced.workflow</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Add workflow status bar -->
                <field name="state" position="before">
                    <field name="custom_status_id" widget="statusbar" options="{'clickable': '1'}" attrs="{'readonly': [('state', 'in', ['sale', 'done', 'cancel'])]}"/>
                </field>

                <!-- Add commission and workflow buttons in header -->
                <button name="action_quotation_send" position="after">
                    <button name="action_change_status" string="Change Status" type="object" class="btn-secondary" icon="fa-exchange"/>
                    <button name="action_view_order_reports" string="Generate Reports" type="object" class="btn-info" icon="fa-file-pdf-o"/>
                </button>

                <!-- Add workflow action buttons based on status -->
                <button name="action_quotation_send" position="after">
                    <!-- Draft to Documentation -->
                    <button name="action_request_documentation" string="Request Documentation" type="object" class="btn-primary" icon="fa-file-text-o" attrs="{'invisible': ['|', ('custom_status_id.code', '!=', 'draft'), ('documentation_user_id', '=', False)]}"/>

                    <!-- Documentation to Commission -->
                    <button name="action_start_commission_calculation" string="Start Commission Calculation" type="object" class="btn-warning" icon="fa-calculator" attrs="{'invisible': ['|', ('custom_status_id.code', '!=', 'documentation_progress'), ('commission_user_id', '=', False)]}"/>

                    <!-- Commission to Final Review -->
                    <button name="action_submit_for_review" string="Submit for Review" type="object" class="btn-info" icon="fa-search" attrs="{'invisible': ['|', ('custom_status_id.code', '!=', 'commission_calculation'), ('final_review_user_id', '=', False)]}"/>

                    <!-- Final Review Actions -->
                    <button name="action_approve_and_post_order" string="Approve &amp; Post Order" type="object" class="btn-success" icon="fa-check" attrs="{'invisible': [('custom_status_id.code', '!=', 'final_review')]}"/>

                    <button name="action_reject_order" string="Reject Order" type="object" class="btn-danger" icon="fa-times" attrs="{'invisible': [('custom_status_id.code', '!=', 'final_review')]}"/>
                </button>

                <!-- Add workflow assignment fields -->
                <page string="Other Information" position="after">
                    <page string="Workflow &amp; Assignment" name="workflow_assignment">
                        <group>
                            <group string="Stage Assignments" name="stage_assignments">
                                <field name="documentation_user_id" options="{'no_create': True}"/>
                                <field name="commission_user_id" options="{'no_create': True}"/>
                                <field name="final_review_user_id" options="{'no_create': True}"/>
                            </group>

                            <group string="Real Estate Details" name="real_estate_details">
                                <field name="booking_date"/>
                                <field name="project_id" options="{'no_create': True}"/>
                                <field name="unit_id" options="{'no_create': True}" domain="[('type', '=', 'product')]"/>
                            </group>
                        </group>

                        <!-- Status History -->
                        <group string="Status History" name="status_history">
                            <field name="custom_status_history_ids" nolabel="1">
                                <tree>
                                    <field name="status_id"/>
                                    <field name="create_date"/>
                                    <field name="create_uid"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                        </group>
                    </page>
                </page>

                <!-- Enhanced Commission Configuration -->
                <page string="Other Information" position="after">
                    <page string="Commission Configuration" name="commission_config">
                        <group>
                            <!-- External Commissions -->
                            <group string="External Commissions" name="external_commissions">
                                <separator string="Broker Commission" colspan="2"/>
                                <field name="broker_partner_id" options="{'no_create': True}"/>
                                <field name="broker_commission_type"/>
                                <field name="broker_rate"/>
                                <field name="broker_amount" readonly="1" widget="monetary"/>

                                <separator string="Referrer Commission" colspan="2"/>
                                <field name="referrer_partner_id" options="{'no_create': True}"/>
                                <field name="referrer_commission_type"/>
                                <field name="referrer_rate"/>
                                <field name="referrer_amount" readonly="1" widget="monetary"/>

                                <separator string="Cashback" colspan="2"/>
                                <field name="cashback_partner_id" options="{'no_create': True}"/>
                                <field name="cashback_commission_type"/>
                                <field name="cashback_rate"/>
                                <field name="cashback_amount" readonly="1" widget="monetary"/>
                            </group>

                            <!-- Internal Commissions -->
                            <group string="Internal Commissions" name="internal_commissions">
                                <separator string="Agent 1 Commission" colspan="2"/>
                                <field name="agent1_partner_id" options="{'no_create': True}"/>
                                <field name="agent1_commission_type"/>
                                <field name="agent1_rate"/>
                                <field name="agent1_amount" readonly="1" widget="monetary"/>

                                <separator string="Agent 2 Commission" colspan="2"/>
                                <field name="agent2_partner_id" options="{'no_create': True}"/>
                                <field name="agent2_commission_type"/>
                                <field name="agent2_rate"/>
                                <field name="agent2_amount" readonly="1" widget="monetary"/>

                                <separator string="Manager Commission" colspan="2"/>
                                <field name="manager_partner_id" options="{'no_create': True}"/>
                                <field name="manager_commission_type"/>
                                <field name="manager_rate"/>
                                <field name="manager_amount" readonly="1" widget="monetary"/>

                                <separator string="Director Commission" colspan="2"/>
                                <field name="director_partner_id" options="{'no_create': True}"/>
                                <field name="director_commission_type"/>
                                <field name="director_rate"/>
                                <field name="director_amount" readonly="1" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Commission Summary -->
                        <group string="Commission Summary" name="commission_summary">
                            <group>
                                <field name="total_external_commission_amount" readonly="1" widget="monetary"/>
                                <field name="total_internal_commission_amount" readonly="1" widget="monetary"/>
                            </group>
                            <group>
                                <field name="total_commission_amount" readonly="1" widget="monetary" style="font-weight: bold; font-size: 1.2em; color: #b19024;"/>
                            </group>
                        </group>
                    </page>
                </page>
            </field>
        </record>

        <!-- Enhanced Sale Order Tree View -->
        <record id="view_order_tree_enhanced_workflow" model="ir.ui.view">
            <field name="name">sale.order.tree.enhanced.workflow</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <field name="state" position="before">
                    <field name="custom_status_id" optional="show"/>
                </field>
                <field name="amount_total" position="after">
                    <field name="total_commission_amount" optional="hide" widget="monetary"/>
                </field>
            </field>
        </record>

        <!-- Order Status Model Views -->
        <record id="view_order_status_form" model="ir.ui.view">
            <field name="name">order.status.form</field>
            <field name="model">order.status</field>
            <field name="arch" type="xml">
                <form string="Order Status">
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name"/>
                            </h1>
                        </div>

                        <group>
                            <group>
                                <field name="code"/>
                                <field name="sequence"/>
                                <field name="color"/>
                                <field name="is_initial"/>
                                <field name="is_final"/>
                            </group>
                            <group>
                                <field name="responsible_type"/>
                                <field name="active"/>
                            </group>
                        </group>

                        <group string="Description">
                            <field name="description" nolabel="1"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_order_status_tree" model="ir.ui.view">
            <field name="name">order.status.tree</field>
            <field name="model">order.status</field>
            <field name="arch" type="xml">
                <tree string="Order Statuses" default_order="sequence">
                    <field name="sequence"/>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="responsible_type"/>
                    <field name="is_initial"/>
                    <field name="is_final"/>
                    <field name="active"/>
                </tree>
            </field>
        </record>

        <!-- Order Status History View -->
        <record id="view_order_status_history_tree" model="ir.ui.view">
            <field name="name">order.status.history.tree</field>
            <field name="model">order.status.history</field>
            <field name="arch" type="xml">
                <tree string="Order Status History" create="false" delete="false" edit="false">
                    <field name="order_id"/>
                    <field name="status_id"/>
                    <field name="previous_status_id"/>
                    <field name="create_date"/>
                    <field name="create_uid"/>
                    <field name="notes"/>
                </tree>
            </field>
        </record>

        <!-- Sales Order Filters for Workflow -->
        <record id="view_sales_order_filter_enhanced" model="ir.ui.view">
            <field name="name">sale.order.select.enhanced</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.sale_order_view_search_inherit_quotation"/>
            <field name="arch" type="xml">
                <filter name="my_quotation" position="after">
                    <separator/>
                    <filter string="Draft Status" name="status_draft" domain="[('custom_status_id.code', '=', 'draft')]"/>
                    <filter string="Documentation Review" name="status_documentation" domain="[('custom_status_id.code', '=', 'documentation_progress')]"/>
                    <filter string="Commission Calculation" name="status_commission" domain="[('custom_status_id.code', '=', 'commission_calculation')]"/>
                    <filter string="Final Review" name="status_final_review" domain="[('custom_status_id.code', '=', 'final_review')]"/>
                    <filter string="Approved" name="status_approved" domain="[('custom_status_id.code', '=', 'approved')]"/>
                    <separator/>
                    <filter string="My Assigned Orders" name="my_assigned" domain="['|', '|', ('documentation_user_id', '=', uid), ('commission_user_id', '=', uid), ('final_review_user_id', '=', uid)]"/>
                </filter>

                <group expand="0" string="Group By" position="inside">
                    <filter string="Workflow Status" name="group_workflow_status" context="{'group_by': 'custom_status_id'}"/>
                    <filter string="Documentation Responsible" name="group_documentation_user" context="{'group_by': 'documentation_user_id'}"/>
                    <filter string="Commission Responsible" name="group_commission_user" context="{'group_by': 'commission_user_id'}"/>
                    <filter string="Review Responsible" name="group_review_user" context="{'group_by': 'final_review_user_id'}"/>
                </group>

                <field name="partner_id" position="after">
                    <field name="custom_status_id"/>
                    <field name="documentation_user_id"/>
                    <field name="commission_user_id"/>
                    <field name="final_review_user_id"/>
                </field>
            </field>
        </record>

        <!-- Enhanced Menu Items -->
        <menuitem id="menu_order_status_config" name="Order Status Configuration" parent="sale.sale_menu_root" sequence="100"/>

        <!-- Order Status Actions -->
        <record id="action_order_status" model="ir.actions.act_window">
            <field name="name">Order Statuses</field>
            <field name="res_model">order.status</field>
            <field name="view_mode">tree,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first order status
                </p>
                <p>
                    Define the workflow stages for your sales orders with custom statuses.
                </p>
            </field>
        </record>

        <record id="action_order_status_history" model="ir.actions.act_window">
            <field name="name">Order Status History</field>
            <field name="res_model">order.status.history</field>
            <field name="view_mode">tree</field>
        </record>

        <!-- Update menu actions -->
        <menuitem id="menu_order_status_master" name="Order Statuses" parent="menu_order_status_config" sequence="1" action="action_order_status"/>

        <menuitem id="menu_order_status_history" name="Status History" parent="menu_order_status_config" sequence="2" action="action_order_status_history"/>

    </data>
</odoo>
