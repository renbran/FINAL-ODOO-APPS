<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Payment Reviewer Group (Base Level) -->
        <record id="group_payment_reviewer" model="res.groups">
            <field name="name">Payment Reviewer</field>
            <field name="category_id" ref="base.module_category_accounting"/>
            <field name="comment">Can review submitted payments and move them to reviewed state</field>
        </record>

        <!-- Payment Approver Group (Level 2) -->
        <record id="group_payment_approver" model="res.groups">
            <field name="name">Payment Approver</field>
            <field name="category_id" ref="base.module_category_accounting"/>
            <field name="comment">Can approve reviewed payments. Must also be a Payment Reviewer.</field>
        </record>

        <!-- Payment Authorizer Group (Level 3) -->
        <record id="group_payment_authorizer" model="res.groups">
            <field name="name">Payment Authorizer</field>
            <field name="category_id" ref="base.module_category_accounting"/>
            <field name="comment">Can authorize approved vendor payments. Must also be a Payment Approver and Reviewer.</field>
        </record>

        <!-- Payment Admin Group (Top Level) -->
        <record id="group_payment_admin" model="res.groups">
            <field name="name">Payment Administrator</field>
            <field name="category_id" ref="base.module_category_accounting"/>
            <field name="comment">Full access to payment approval workflow including reset capabilities</field>
        </record>

    </data>
    
    <!-- Separate data section for implied_ids to avoid circular references -->
    <data noupdate="1">
        
        <!-- Set up group hierarchy after all groups are created -->
        <record id="group_payment_approver" model="res.groups">
            <field name="implied_ids" eval="[(4, ref('payment_approval_workflow.group_payment_reviewer'))]"/>
        </record>

        <record id="group_payment_authorizer" model="res.groups">
            <field name="implied_ids" eval="[(4, ref('payment_approval_workflow.group_payment_approver'))]"/>
        </record>

        <record id="group_payment_admin" model="res.groups">
            <field name="implied_ids" eval="[(4, ref('payment_approval_workflow.group_payment_authorizer'))]"/>
        </record>

        <!-- Record Rules -->
        
        <!-- Reviewers can only see submitted payments in their company -->
        <record id="payment_reviewer_rule" model="ir.rule">
            <field name="name">Payment Reviewer Access</field>
            <field name="model_id" ref="account.model_account_payment"/>
            <field name="domain_force">[('company_id', 'in', company_ids), ('approval_state', 'in', ['submitted', 'reviewed', 'approved', 'authorized', 'posted'])]</field>
            <field name="groups" eval="[(4, ref('payment_approval_workflow.group_payment_reviewer'))]"/>
        </record>

        <!-- Approvers can see reviewed and approved payments -->
        <record id="payment_approver_rule" model="ir.rule">
            <field name="name">Payment Approver Access</field>
            <field name="model_id" ref="account.model_account_payment"/>
            <field name="domain_force">[('company_id', 'in', company_ids), ('approval_state', 'in', ['reviewed', 'approved', 'authorized', 'posted'])]</field>
            <field name="groups" eval="[(4, ref('payment_approval_workflow.group_payment_approver'))]"/>
        </record>

        <!-- Authorizers can see approved payments -->
        <record id="payment_authorizer_rule" model="ir.rule">
            <field name="name">Payment Authorizer Access</field>
            <field name="model_id" ref="account.model_account_payment"/>
            <field name="domain_force">[('company_id', 'in', company_ids), ('approval_state', 'in', ['approved', 'authorized', 'posted'])]</field>
            <field name="groups" eval="[(4, ref('payment_approval_workflow.group_payment_authorizer'))]"/>
        </record>

        <!-- Admins can see all payments -->
        <record id="payment_admin_rule" model="ir.rule">
            <field name="name">Payment Admin Access</field>
            <field name="model_id" ref="account.model_account_payment"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
            <field name="groups" eval="[(4, ref('payment_approval_workflow.group_payment_admin'))]"/>
        </record>

    </data>
</odoo>
